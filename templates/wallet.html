{% extends 'base.html' %}

{% block style %}
<script src="https://unpkg.com/@tonconnect/ui@2.0.1/dist/tonconnect-ui.min.js"></script>
<style>
    .wallet-container {
        padding: 16px;
        max-width: 600px;
        margin: 0 auto;
    }

    .wallet-header {
        display: flex;
        align-items: center;
        margin-bottom: 24px;
    }

    .back-button {
        background: none;
        border: none;
        padding: 8px;
        margin-right: 12px;
        cursor: pointer;
    }

    .back-button svg {
        width: 24px;
        height: 24px;
        color: var(--text-color);
    }

    .wallet-title {
        font-size: 20px;
        font-weight: bold;
    }

    .balance-card {
        background-color: var(--card-bg);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 16px;
        box-shadow: 0 2px 8px var(--shadow-color);
    }

    .balance-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }

    .balance-title {
        font-size: 16px;
        font-weight: 500;
        color: var(--text-color);
        opacity: 0.8;
    }

    .balance-amount {
        font-size: 28px;
        font-weight: bold;
        margin-bottom: 8px;
    }

    .balance-currency {
        font-size: 16px;
        color: var(--text-color);
        opacity: 0.6;
    }

    .balance-actions {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-top: 20px;
    }

    .balance-button {
        padding: 12px;
        border-radius: 8px;
        background-color: var(--primary-color);
        color: white;
        border: none;
        font-size: 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .balance-button.outline {
        background-color: transparent;
        border: 1px solid var(--primary-color);
        color: var(--primary-color);
    }

    .balance-button svg {
        width: 18px;
        height: 18px;
    }

    .history-title {
        font-size: 18px;
        font-weight: bold;
        margin: 24px 0 12px;
    }

    .history-empty {
        text-align: center;
        padding: 24px;
        color: var(--text-color);
        opacity: 0.6;
    }

    .ton-connect-button {
        width: 100%;
        padding: 8px;
        border-radius: 12px;
        color: none;
        background-color: var(--bg-color);
        border: none;
        font-size: 16px;
        cursor: pointer;
        margin: 16px 0;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .ton-connect-button svg {
        width: 20px;
        height: 20px;
    }

    .currency-switcher {
        position: fixed;
        bottom: 80px;
        right: 16px;
        z-index: 100;
    }

    .currency-button {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background-color: var(--primary-color);
        color: white;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .currency-button svg {
        width: 24px;
        height: 24px;
    }

    .history-item {
        display: flex;
        justify-content: space-between;
        padding: 12px 0;
        border-bottom: 1px solid var(--border-color);
    }

    .history-item-info {
        flex: 1;
    }

    .history-item-title {
        font-weight: 500;
        margin-bottom: 4px;
    }

    .history-item-date {
        font-size: 12px;
        color: var(--text-color);
        opacity: 0.6;
    }

    .history-item-amount {
        font-weight: bold;
    }

    .history-item-amount.positive {
        color: #4CAF50;
    }

    .history-item-amount.negative {
        color: #F44336;
    }

    #ton-connect button {
        width: 100% !important;
        background-color: var(--primary-color) !important;
        color: white !important;
        border: none !important;
        border-radius: 20px !important;
        padding: 10px 16px !important;
        font-size: 8px !important;
        cursor: pointer !important;
        white-space: nowrap !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="wallet-container">
    <div class="wallet-header">
        <button class="back-button" onclick="window.location.href='/store'">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 12H5"></path>
                <path d="M12 19l-7-7 7-7"></path>
            </svg>
        </button>
        <h1 class="wallet-title">Мой кошелёк</h1>
    </div>

    <div class="balance-card" id="rubBalanceCard">
        <div class="balance-header">
            <div class="balance-title">Рублёвый счёт</div>
        </div>
        <div class="balance-amount" id="rubBalanceAmount">0 ₽</div>
        
        <div class="balance-actions">
            <button class="balance-button" id="depositRubButton">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="19" x2="12" y2="5"></line>
                    <polyline points="5 12 12 5 19 12"></polyline>
                </svg>
                Пополнить
            </button>
            <button class="balance-button outline" id="withdrawRubButton">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <polyline points="19 12 12 19 5 12"></polyline>
                </svg>
                Вывести
            </button>
        </div>
    </div>

    <div class="balance-card" id="tonBalanceCard" style="display: none;">
        <div class="balance-header">
            <div class="balance-title">TON счёт</div>
        </div>
        <div class="balance-amount" id="tonBalanceAmount">0 TON</div>
        
        <div class="balance-actions">
            <button class="balance-button" id="depositTonButton">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="19" x2="12" y2="5"></line>
                    <polyline points="5 12 12 5 19 12"></polyline>
                </svg>
                Пополнить
            </button>
            <button class="balance-button outline" id="withdrawTonButton">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <polyline points="19 12 12 19 5 12"></polyline>
                </svg>
                Вывести
            </button>
        </div>
    </div>

    <button class="ton-connect-button" id="tonConnectButton" style="display: none;">
        <div id="ton-connect"></div>
    </button>

    <h2 class="history-title" id="rubHistoryTitle">История операций (рубли)</h2>
    <h2 class="history-title" id="tonHistoryTitle" style="display: none;">История операций (TON)</h2>

    <div id="rubHistory">
        <div class="history-empty">Нет операций</div>
    </div>

    <div id="tonHistory" style="display: none;">
        <div class="history-empty">Нет операций</div>
    </div>

    <div class="currency-switcher">
        <button class="currency-button" id="currencySwitchButton">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M7 16V4h5v4"></path>
                <path d="M17 8V20h-5v-4"></path>
                <path d="M3 12h18"></path>
            </svg>
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', async () => {
        // Функция для форматирования баланса
        function formatBalance(balance, isRub) {
            if (balance === 0) {
                return isRub ? '0 ₽' : '0 TON';
            }
            
            // Округляем до 2 знаков, убираем лишние нули
            const formatted = parseFloat(balance.toFixed(2));
            return isRub ? `${formatted} ₽` : `${formatted} TON`;
        }

        // Функция для обновления всех балансов
        async function updateAllBalances() {
            try {
                const response = await fetch('/get_wallet_balance');
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        // Обновляем отображение в кошельке
                        document.getElementById('rubBalanceAmount').textContent = 
                            formatBalance(data.rub_balance, true);
                        document.getElementById('tonBalanceAmount').textContent = 
                            formatBalance(data.ton_balance, false);
                        
                        // Обновляем текущий баланс в зависимости от выбранной валюты
                        document.getElementById('walletBalance').textContent = 
                            currentCurrency === 'rub' 
                                ? formatBalance(data.rub_balance, true)
                                : formatBalance(data.ton_balance, false);
                    }
                }
            } catch (error) {
                console.error('Error updating balances:', error);
            }
        }

        // Инициализация TonConnectUI
        const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
            manifestUrl: 'https://gist.githubusercontent.com/Warder222/9c67c2e96851c412c58cca16923cf778/raw/a540ad5d6dbd714ce05e8c628cfd47fe22c10803/tonconnect-manifest.json',
            buttonRootId: 'ton-connect',
            language: 'ru',
            uiPreferences: {
                theme: window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches 
                    ? TON_CONNECT_UI.THEME.DARK 
                    : TON_CONNECT_UI.THEME.LIGHT
            }
        });

        // Переключение между рублями и TON
        const currencySwitchButton = document.getElementById('currencySwitchButton');
        const rubBalanceCard = document.getElementById('rubBalanceCard');
        const tonBalanceCard = document.getElementById('tonBalanceCard');
        const rubHistoryTitle = document.getElementById('rubHistoryTitle');
        const tonHistoryTitle = document.getElementById('tonHistoryTitle');
        const rubHistory = document.getElementById('rubHistory');
        const tonHistory = document.getElementById('tonHistory');
        const tonConnectButton = document.getElementById('tonConnectButton');
        
        let currentCurrency = 'rub';

        // Загружаем текущую валюту из базы данных
        try {
            const response = await fetch('/get_currency');
            if (response.ok) {
                const data = await response.json();
                if (data.currency === 'ton') {
                    // Имитируем клик по кнопке переключения валюты
                    currentCurrency = 'ton';
                    rubBalanceCard.style.display = 'none';
                    tonBalanceCard.style.display = 'block';
                    rubHistoryTitle.style.display = 'none';
                    tonHistoryTitle.style.display = 'block';
                    rubHistory.style.display = 'none';
                    tonHistory.style.display = 'block';
                    tonConnectButton.style.display = 'flex';
                }
            }
        } catch (error) {
            console.error('Error loading currency preference:', error);
        }

        currencySwitchButton.addEventListener('click', async (e) => {
            e.stopPropagation();
            
            if (currentCurrency === 'rub') {
                // Переключаемся на TON
                rubBalanceCard.style.display = 'none';
                tonBalanceCard.style.display = 'block';
                rubHistoryTitle.style.display = 'none';
                tonHistoryTitle.style.display = 'block';
                rubHistory.style.display = 'none';
                tonHistory.style.display = 'block';
                tonConnectButton.style.display = 'flex';
                currentCurrency = 'ton';
            } else {
                // Переключаемся на рубли
                rubBalanceCard.style.display = 'block';
                tonBalanceCard.style.display = 'none';
                rubHistoryTitle.style.display = 'block';
                tonHistoryTitle.style.display = 'none';
                rubHistory.style.display = 'block';
                tonHistory.style.display = 'none';
                tonConnectButton.style.display = 'none';
                currentCurrency = 'rub';
            }
            
            // Сохраняем выбор валюты
            await fetch('/set_currency', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ currency: currentCurrency })
            });

            // Обновляем балансы
            await updateAllBalances();
        });

        // Обработчики кнопок
        document.getElementById('depositRubButton').addEventListener('click', () => {
            alert('Функция пополнения рублёвого счёта будет реализована позже');
        });

        document.getElementById('withdrawRubButton').addEventListener('click', () => {
            alert('Функция вывода с рублёвого счёта будет реализована позже');
        });

        document.getElementById('depositTonButton').addEventListener('click', () => {
            alert('Функция пополнения TON счёта будет реализована позже');
        });

        document.getElementById('withdrawTonButton').addEventListener('click', () => {
            alert('Функция вывода с TON счёта будет реализована позже');
        });

        // Обработчик для кнопки TonConnect
        document.getElementById('ton-connect').addEventListener('click', async (e) => {
            if (e.target.tagName === 'BUTTON') {
                try {
                    // Проверяем, подключен ли уже кошелек
                    const connectedWallets = await tonConnectUI.getConnectedWallets();
                    if (connectedWallets.length > 0) {
                        // Кошелек уже подключен - ничего не делаем
                        console.log('Кошелек уже подключен:', connectedWallets[0]);
                        return;
                    }
                    
                    // Если кошелек не подключен - открываем модальное окно подключения
                    const connectedWallet = await tonConnectUI.connectWallet();
                    console.log(connectedWallet);
                } catch (error) {
                    console.log(`Error connecting to wallet: ${error}`);
                }
            }
        });

        // Обновляем балансы при загрузке
        await updateAllBalances();
    });
</script>
{% endblock %}