{% extends "base.html" %}

{% block style %}
<style>
    a {
        text-decoration: none;
    }
    .profile-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        position: sticky;
        top: 0;
        background-color: var(--bg-color);
        z-index: 100;
        border-bottom: 1px solid var(--border-color);
    }

    .profile-title {
        font-size: 18px;
        font-weight: bold;
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
    }

    .header-icon {
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        position: relative;
        z-index: 101;
    }

    .referrals-count {
        font-size: 14px;
        color: var(--secondary-text);
        margin-right: 10px;
    }

    .header-right {
        display: flex;
        align-items: center;
    }

    /* Стили для выпадающего меню */
    .dropdown-menu {
        position: absolute;
        top: 100%;
        left: 0;
        background-color: var(--bg-color);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        width: 200px;
        z-index: 1000;
        display: none;
        overflow: hidden;
    }

    .dropdown-menu.show {
        display: block;
        animation: fadeIn 0.2s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .dropdown-item {
        padding: 12px 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: background-color 0.2s;
    }

    .dropdown-item:hover {
        background-color: var(--card-bg);
    }

    .dropdown-item svg {
        width: 18px;
        height: 18px;
    }

    /* Остальные стили */
    body {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
    }

    main {
        flex: 1;
        padding-bottom: 80px;
    }

    .profile-info {
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
    }

    .avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid var(--primary-color);
    }

    .username {
        font-size: 20px;
        font-weight: bold;
    }

    .reputation-container,
    .earned-container {
        width: 100%;
        background-color: var(--card-bg);
        border-radius: 12px;
        padding: 15px;
        margin-top: 10px;
    }

    .reputation-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
    }

    .reputation-title {
        font-weight: bold;
    }

    .reputation-value {
        font-weight: bold;
    }

    .positive { color: #4CAF50; }
    .negative { color: #F44336; }
    .neutral { color: var(--text-color); }

    .reviews-count {
        margin-bottom: 15px;
        cursor: pointer;
        color: var(--secondary-text);
        transition: color 0.2s;
    }

    .reputation-bar {
        width: 100%;
        height: 15px;
        background-color: #F44336;
        border-radius: 10px;
        overflow: hidden;
        position: relative;
        margin-top: 15px;
    }

    .reputation-fill {
        height: 100%;
        background-color: #4CAF50;
        position: absolute;
        left: 0;
        top: 0;
        transition: width 0.3s ease;
    }

    .reputation-labels {
        display: flex;
        justify-content: space-between;
        margin-top: 5px;
        font-size: 12px;
        color: var(--secondary-text);
    }

    .earned-title {
        font-weight: bold;
        margin-bottom: 10px;
    }

    .earned-amount {
        font-size: 24px;
        font-weight: bold;
        color: var(--primary-color);
    }

    .ads-section {
        width: 100%;
        margin-top: 20px;
    }

    .ads-section-title {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 15px;
        padding-left: 5px;
    }

    .ads-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 16px;
    }

    .ad-card {
        background-color: var(--card-bg);
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px var(--shadow-color);
        cursor: pointer;
        height: 300px;
        position: relative;
    }

    .ad-image {
        width: 100%;
        height: 200px;
        object-fit: cover;
    }

    .ad-details {
        padding: 12px;
    }

    .ad-price {
        font-weight: bold;
        margin-bottom: 10px;
        color: var(--primary-color);
    }

    .ad-description {
        font-size: 12px;
        color: #999;
    }

    .ad-new-badge {
        position: absolute;
        top: 10px;
        left: 10px;
        background-color: var(--primary-color);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
        z-index: 10;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .ad-title {
        font-size: 18px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 170%;
        display: block;
        position: relative;
        bottom: 0.55vh;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        line-height: 1.2em;
    }

    .ad-title::after {
        content: "";
        position: absolute;
        bottom: 0;
        right: 0;
        width: 30%;
        height: 1.2em;
        background: linear-gradient(90deg, rgba(255,255,255,0), var(--card-bg) 70%);
        pointer-events: none;
    }

    .ad-favorite, .ad-favorite-del {
        float: right;
        position: relative;
        top: 20px;
        z-index: 2;
        pointer-events: auto;
    }

    .ad-favorite-del svg {
        fill: currentColor;
    }

    .no-results {
        grid-column: 1 / -1;
        text-align: center;
        padding: 40px 20px;
        color: #999;
    }

    .avatar-container {
        position: relative;
        display: inline-block;
        margin-top: 40px; /* Опускаем весь блок с аватаром ниже */
    }

    .admin-crown {
        position: absolute;
        top: -50px; /* Поднимаем корону выше */
        left: 50%;
        transform: translateX(-50%);
        width: 120px; /* Увеличиваем размер короны */
        height: 70px;
        z-index: 10;
        filter: drop-shadow(0 3px 6px rgba(33, 150, 243, 0.4));
        transition: all 0.3s ease;
        animation: crown-float 3s ease-in-out infinite alternate;
        fill: #1976D2; /* Синий цвет короны */
    }

    .moderator-hat {
        position: absolute;
        top: -30px;
        left: 50%;
        transform: translateX(-50%);
        width: 100px;
        height: 80px;
        z-index: 10;
        filter: 
            drop-shadow(0 0 2px white) /* Белая обводка */
            drop-shadow(0 0 2px white) /* Дублируем для лучшей видимости */
            drop-shadow(0 3px 6px rgba(25, 118, 210, 0.4));
        transition: all 0.3s ease;
        animation: hat-shine 2s ease-in-out infinite;
        fill: #1976D2;
    }

    {% if admin_crown or moderator_hat %}
        .avatar {
            margin-top: 20px;
        }
    {% endif %}

    .avatar-container:hover .admin-crown {
        transform: translateX(-50%) scale(1.15);
        filter: drop-shadow(0 5px 10px rgba(33, 150, 243, 0.6));
    }

    @keyframes crown-float {
        0% { transform: translateX(-50%) translateY(0px); }
        100% { transform: translateX(-50%) translateY(-8px); }
    }

    @keyframes hat-shine {
        0% { 
            filter: 
                drop-shadow(0 0 2px white)
                drop-shadow(0 0 2px white)
                drop-shadow(0 3px 6px rgba(25, 118, 210, 0.4)); 
        }
        50% { 
            filter: 
                drop-shadow(0 0 2px white)
                drop-shadow(0 0 2px white)
                drop-shadow(0 3px 12px rgba(25, 118, 210, 0.8)); 
        }
        100% { 
            filter: 
                drop-shadow(0 0 2px white)
                drop-shadow(0 0 2px white)
                drop-shadow(0 3px 6px rgba(25, 118, 210, 0.4)); 
        }
    }

    .avatar-container:hover .moderator-hat {
        transform: translateX(-50%) scale(1.1);
        filter: 
            drop-shadow(0 0 2px white)
            drop-shadow(0 0 2px white)
            drop-shadow(0 5px 10px rgba(25, 118, 210, 0.6));
    }

    @media (max-width: 400px) {
        .ads-grid {
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        }
    }

    .earned-container {
        width: 100%;
        background-color: var(--card-bg);
        border-radius: 12px;
        padding: 15px;
        margin-top: 10px;
    }

    .earned-title {
        font-weight: bold;
        margin-bottom: 10px;
    }

    .earned-amount {
        display: flex;
        gap: 20px;
        align-items: center;
    }

    .earned-currency {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .currency-symbol {
        font-size: 16px;
        color: var(--primary-color);
        font-weight: bold;
    }

    .earned-currency span:last-child {
        font-size: 20px;
        font-weight: bold;
        color: var(--text-color);
    }

    /* Модальное окно с отзывами */
    .reviews-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 2000;
        display: none;
        justify-content: center;
        align-items: center;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .reviews-modal.show {
        display: flex;
        opacity: 1;
    }

    .reviews-content {
        background-color: var(--bg-color);
        border-radius: 12px;
        width: 90%;
        max-width: 500px;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        transform: translateY(20px);
        transition: transform 0.3s ease;
    }

    .reviews-modal.show .reviews-content {
        transform: translateY(0);
    }

    .reviews-header {
        padding: 16px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .reviews-title {
        font-size: 18px;
        font-weight: bold;
    }

    .close-reviews {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: var(--secondary-text);
        padding: 4px;
    }

    .reviews-list {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
    }

    .review-item {
        padding: 12px 0;
        border-bottom: 1px solid var(--border-color);
    }

    .review-item:last-child {
        border-bottom: none;
    }

    .review-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
    }

    .review-author {
        font-weight: bold;
    }

    .review-date {
        color: var(--secondary-text);
        font-size: 12px;
    }

    .review-rating {
        display: inline-block;
        margin-right: 8px;
        font-weight: bold;
    }

    .review-rating.positive {
        color: #4CAF50;
    }

    .review-rating.negative {
        color: #F44336;
    }

    .review-text {
        margin-top: 8px;
        line-height: 1.4;
    }

    .no-reviews {
        text-align: center;
        padding: 40px 20px;
        color: var(--secondary-text);
    }
    
    .loading-indicator {
        text-align: center;
        padding: 20px;
        color: #999;
        display: none;
    }

    .ad-favorite, .ad-favorite-del {
        cursor: pointer;
        transition: all 0.3s ease;
        transform-origin: center;
    }

    .ad-favorite svg {
        fill: none;
        stroke: currentColor;
        transition: all 0.3s ease;
    }

    .ad-favorite-del svg {
        fill: currentColor;
        stroke: currentColor;
        animation: pulse 0.5s ease;
    }

    @keyframes pulse {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.3); opacity: 0.8; }
        100% { transform: scale(1); opacity: 1; }
    }

    .tooltip {
        position: absolute;
        background: var(--card-bg);
        color: var(--text-color);
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 500;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        white-space: nowrap;
        pointer-events: none;
        border: 1px solid var(--border-color);
    }

    .tooltip.show {
        opacity: 1;
        visibility: visible;
    }

    .tooltip::before {
        content: '';
        position: absolute;
        width: 10px;
        height: 10px;
        background: var(--card-bg);
        transform: rotate(45deg);
        border-bottom: 1px solid var(--border-color);
        border-right: 1px solid var(--border-color);
    }

    .admin-crown-tooltip {
        top: -80px;
        left: 50%;
        transform: translateX(-50%);
    }

    .admin-crown-tooltip::before {
        bottom: -5px;
        left: 50%;
        transform: translateX(-50%) rotate(45deg);
    }

    .moderator-hat-tooltip {
        top: -60px;
        left: 50%;
        transform: translateX(-50%);
    }

    .moderator-hat-tooltip::before {
        bottom: -5px;
        left: 50%;
        transform: translateX(-50%) rotate(45deg);
    }

    .avatar-container {
        position: relative;
        cursor: pointer;
    }

    .header-icon.disabled {
        pointer-events: none;
        opacity: 0.5;
        cursor: default;
    }
</style>
{% endblock %}

{% block content %}
{% if is_blocked %}
<div style="background-color: #ffebee; color: #c62828; padding: 16px; text-align: center; border-radius: 8px; margin: 16px 0;">
    ⚠️ Этот пользователь временно заблокирован
</div>
{% endif %}
<main>
    <div class="profile-header">
        <div class="header-icon {% if user_info['tg_id'] != user_tg_id %}disabled{% endif %}" id="menuButton">
            {% if user_info["tg_id"] == user_tg_id %}
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="18" cy="5" r="3"></circle>
                <circle cx="6" cy="12" r="3"></circle>
                <circle cx="18" cy="19" r="3"></circle>
                <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
            </svg>
            <div class="dropdown-menu" id="dropdownMenu">
                <div class="dropdown-item" id="shareReferral">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                        <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                    </svg>
                    Поделиться реферальной ссылкой
                </div>
            </div>
            {% endif %}
        </div>
        <div class="profile-title">Профиль</div>
        {% if user_info["tg_id"] == user_tg_id %}
        <div class="header-right">
            <div class="referrals-count">{{ referrals_count }} реф.</div>
        </div>
        {% endif %}
    </div>

    <div class="profile-info">
        <div class="avatar-container">
            {% if admin_crown %}
                <svg class="admin-crown" viewBox="0 0 170.23 170.23">
                    <path d="M168.695,54.759c-1.424-1.124-3.406-1.187-4.861-0.119l-45.395,32.329L88.771,24.415c-1.34-2.818-5.98-2.818-7.309,0 L51.446,87.702L6.448,54.672c-1.46-1.079-3.464-1.042-4.899,0.081c-1.429,1.124-1.936,3.051-1.239,4.736l30.955,74.667 c0.147,0.343,0.385,0.606,0.606,0.896c5.938,10.035,35.158,12.878,53.246,12.878c17.95,0,46.886-2.79,53.124-12.646 c0.29-0.332,0.549-0.696,0.723-1.129l30.961-74.667C170.61,57.81,170.119,55.887,168.695,54.759z M85.112,139.819 c-28.039,0-44.645-5.543-46.269-8.264c-0.011-0.048-0.011-0.09-0.021-0.121c1.529-3.164,18.151-8.754,46.291-8.754 c28.271,0,44.946,5.647,46.327,8.342C130.058,134.171,113.383,139.819,85.112,139.819z M134.561,123.608 c-10.183-6.935-33.919-9.039-49.449-9.039c-15.53,0-39.277,2.104-49.449,9.039L13.34,69.777L50.597,97.12 c0.981,0.717,2.22,0.96,3.385,0.664c1.176-0.301,2.152-1.097,2.668-2.193L85.112,35.6l28.081,59.21 c0.512,1.081,1.472,1.888,2.632,2.183c1.16,0.307,2.395,0.074,3.37-0.622l37.831-26.952L134.561,123.608z"/>
                </svg>
                <div class="tooltip admin-crown-tooltip">Основатель маркета</div>
            {% elif moderator_hat %}
                <svg class="moderator-hat" viewBox="0 0 318.52 318.519">
                    <path d="M32.38,191.358h22.489v-21.412h21.409v21.412h21.412v-21.412h21.412v21.412h21.412v-21.412h18.787h2.619v0.177v21.235 h-2.619h-18.792v21.411h-21.412v-21.411H97.684v21.411H76.272v-21.411H54.863v21.411H42.646v9.854 c15.907,55.83,116.653,49.026,116.653,49.026s100.748,6.799,116.654-49.026v-22.898c0,0,4.257-3.459,10.025-8.187h-17.016v21.412 h-21.411v-21.412h-21.411v21.412h-21.412v-21.412h-21.411v21.23h-21.409v-21.23h21.409v-0.181v-21.23h21.411v21.411h21.412 v-21.411h21.411v21.411h21.411v-21.411h21.412v17.797c10.609-8.725,23.726-19.636,27.024-22.913 c5.753-5.727-12.257-12.174-17.575-36.151c-5.317-23.977-3.898-32.565-25.01-34.714c-21.116-2.146-55.432-3.578-82.627-27.558 c-27.195-23.975-32.889-19.682-32.889-19.682s-5.753-4.292-32.949,19.682C99.154,90.568,64.767,92,43.653,94.146 c-21.114,2.149-19.672,10.737-24.99,34.714s-23.294,30.424-17.541,36.151C4.871,168.74,21.34,182.327,32.38,191.358z" 
                        fill="#1976D2"/>
                </svg>
                <div class="tooltip moderator-hat-tooltip">Модератор маркета</div>
            {% endif %}
            <img src="{{ user_info['photo_url'] }}" alt="Аватар" class="avatar">
        </div>
        <div class="username">{{ user_info["first_name"] }}</div>
        {% if user_info["tg_id"] == user_tg_id %}
        <div class="earned-container">
            <div class="earned-title">Заработано</div>
            <div class="earned-amount">
                <div class="earned-currency">
                    <span class="currency-symbol">TON</span>
                    <span id="earnedTon">{{ "%.2f"|format(user_info["earned_ton"]) if user_info["earned_ton"] else "0.00" }}</span>
                </div>
                <div class="earned-currency">
                    <span class="currency-symbol">₽</span>
                    <span id="earnedRub">загрузка...</span>
                </div>
            </div>
        </div>
        {% endif %}
        <div class="reputation-container" id="reputationContainer">
            <div class="reputation-header">
                <div class="reputation-title">Репутация</div>
                <div class="reputation-value 
                    {% if reputation > 0 %}positive
                    {% elif reputation < 0 %}negative
                    {% else %}neutral{% endif %}">
                    {% if reputation > 0 %}+{% endif %}{{ reputation }}
                </div>
            </div>
            <div class="reviews-count" id="reviewsCount">
                {{ positive_reviews + negative_reviews }} 
                {% set total_reviews = positive_reviews + negative_reviews %}
                {% if total_reviews % 10 == 1 and total_reviews % 100 != 11 %}
                    отзыв
                {% elif total_reviews % 10 >= 2 and total_reviews % 10 <= 4 and (total_reviews % 100 < 10 or total_reviews % 100 >= 20) %}
                    отзыва
                {% else %}
                    отзывов
                {% endif %}
            </div>
            
            <div class="reputation-bar">
                <div class="reputation-fill" 
                     style="width: {{ (positive_reviews / (positive_reviews + negative_reviews) * 100) if (positive_reviews + negative_reviews) > 0 else 50 }}%">
                </div>
            </div>
            <div class="reputation-labels">
                <span class="positive">{{ positive_reviews }}</span>
                <span class="negative">{{ negative_reviews }}</span>
            </div>
        </div>

        {% if user_info["tg_id"] != user_tg_id %}
        <div class="ads-section">
            <div class="ads-section-title">Объявления</div>
            <div class="ads-grid" id="adsGrid">
                <!-- Товары будут загружаться динамически -->
            </div>
            <div class="loading-indicator" id="loadingIndicator">
                Загрузка товаров {{ user_info["first_name"] }}...
            </div>
        </div>
        {% endif %}
    </div>
</main>

<!-- Модальное окно с отзывами -->
<div class="reviews-modal" id="reviewsModal">
    <div class="reviews-content">
        <div class="reviews-header">
            <div class="reviews-title">Отзывы</div>
            <button class="close-reviews" id="closeReviews">&times;</button>
        </div>
        <div class="reviews-list" id="reviewsList">
            <!-- Отзывы будут загружены через JavaScript -->
            <div class="no-reviews">Загрузка отзывов...</div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="/static/js/price_conv.js"></script>
<script>
    async function convertTonToRub() {
        try {
            const response = await fetch('/get_ton_to_rub_rate');
            const data = await response.json();
            
            if (data.rate) {
                const earnedTon = parseFloat(document.getElementById('earnedTon').textContent);
                const earnedRub = earnedTon * data.rate;
                document.getElementById('earnedRub').textContent = earnedRub.toFixed(2);
            } else {
                document.getElementById('earnedRub').textContent = 'ошибка';
            }
        } catch (error) {
            console.error('Ошибка конвертации:', error);
            document.getElementById('earnedRub').textContent = 'ошибка';
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        {% if is_blocked %}
            // Отключаем все интерактивные элементы
            document.querySelectorAll('.ad-card').forEach(card => {
                card.style.opacity = "0.6";
                card.style.pointerEvents = "none";
            });
            
            // Отключаем кнопки избранного
            document.querySelectorAll('.ad-favorite, .ad-favorite-del').forEach(btn => {
                btn.style.pointerEvents = "none";
                btn.style.opacity = "0.5";
            });
        {% endif %}

        // Инициализация переменных для пагинации
        let currentPage = 1;
        let isLoading = false;
        let hasMore = true;
        const sellerId = {{ user_info["tg_id"] }};
        const currentUserId = {{ user_tg_id }};

        // Функция для загрузки товаров
        async function loadProducts(page) {
            if (isLoading || !hasMore) return;
            
            isLoading = true;
            document.getElementById('loadingIndicator').style.display = 'block';
            
            try {
                const response = await fetch(`/api/user_products?user_id=${sellerId}&page=${page}`);
                const data = await response.json();
                
                if (data.products.length === 0) {
                    hasMore = false;
                } else {
                    renderProducts(data.products);
                    currentPage = page;
                }
            } catch (error) {
                console.error('Error loading products:', error);
                document.getElementById('adsGrid').innerHTML = `
                    <div class="no-results">
                        Ошибка загрузки товаров. Пожалуйста, попробуйте позже.
                    </div>
                `;
            } finally {
                isLoading = false;
                document.getElementById('loadingIndicator').style.display = 'none';
            }
        }

        // Функция для форматирования даты
        function formatDate(dateString) {
            if (!dateString) return '';
            const [datePart, timePart] = dateString.split(' ');
            const [year, month, day] = datePart.split('-');
            return `${day}.${month}.${year.slice(2)}`;
        }

        // Функция для отрисовки товаров
        function renderProducts(products) {
            const adsGrid = document.getElementById('adsGrid');
            
            products.forEach(product => {
                const isNew = (new Date() - new Date(product["created_at"])) / (1000 * 60 * 60 * 24) < 1;
                const isFavorite = product["is_fav"]; // Индекс 7 - это флаг избранного
                
                const productHtml = `
                    <div class="ads-container">
                        <div class="ad-card" data-id="${product['product_id']}">
                            ${isNew ? '<div class="ad-new-badge">Новое</div>' : ''}
                            <img src="/${product['product_image_url']}" class="ad-image">
                            <div class="ad-details">
                                <div class="ad-title">${product["product_name"]}</div>
                                ${sellerId !== currentUserId ? 
                                (isFavorite ?
                                `<div class="ad-favorite-del" data-id="${product['product_id']}">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2">
                                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                                    </svg>
                                </div>` : 
                                `<div class="ad-favorite" data-id="${product['product_id']}">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                                    </svg>
                                </div>`) : ''}
                                <div class="ad-price">${product["product_price"]} TON</div>
                                <div class="ad-description"><b>${formatDate(product["created_at"])}</b> ${product["created_at"].split(' ')[1]}</div>
                            </div>
                        </div>
                    </div>
                `;
                
                adsGrid.insertAdjacentHTML('beforeend', productHtml);
            });
            
            // Устанавливаем обработчики событий для новых товаров
            setupProductClickHandlers();
        }

        // Функция для обновления состояния избранного
        function updateFavoriteIcon(button, isFavorite) {
            if (isFavorite) {
                button.innerHTML = `
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2">
                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                    </svg>
                `;
                button.classList.remove('ad-favorite');
                button.classList.add('ad-favorite-del');
            } else {
                button.innerHTML = `
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                    </svg>
                `;
                button.classList.remove('ad-favorite-del');
                button.classList.add('ad-favorite');
            }
        }

        // Установка обработчиков событий для товаров
        function setupProductClickHandlers() {
            document.addEventListener('click', async (e) => {
                // Обработка избранного
                const favBtn = e.target.closest('.ad-favorite, .ad-favorite-del');
                
                if (favBtn) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const productId = favBtn.dataset.id;
                    const isFavorite = favBtn.classList.contains('ad-favorite-del');
                    const action = isFavorite ? '/del_fav' : '/add_fav';
                    
                    try {
                        // Показываем анимацию
                        favBtn.style.transform = 'scale(1.2)';
                        setTimeout(() => {
                            favBtn.style.transform = 'scale(1)';
                        }, 300);
                        
                        const response = await fetch(action, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: `fav_id=${productId}`
                        });
                        
                        if (response.ok) {
                            updateFavoriteIcon(favBtn, !isFavorite);
                        }
                    } catch (error) {
                        console.error('Error updating favorite:', error);
                    }
                }
                
                // Обработка клика по карточке товара
                const card = e.target.closest('.ad-card');
                if (card && !e.target.closest('.ad-favorite, .ad-favorite-del')) {
                    const productId = card.dataset.id;
                    window.location.href = `/ads/${productId}`;
                }
            });
        }

        // Обработчик скролла для бесконечной подгрузки
        window.addEventListener('scroll', () => {
            const { scrollTop, scrollHeight, clientHeight } = document.documentElement;
            
            if (scrollTop + clientHeight >= scrollHeight - 100 && !isLoading && hasMore) {
                loadProducts(currentPage + 1);
            }
        });

        // Загружаем первую страницу товаров
        loadProducts(1);

        // Обработчик клика на контейнер репутации
        const reputationContainer = document.getElementById('reputationContainer');
        const reviewsModal = document.getElementById('reviewsModal');
        const closeReviews = document.getElementById('closeReviews');
        const reviewsList = document.getElementById('reviewsList');

        // Открытие модального окна
        reputationContainer.addEventListener('click', async function(e) {
            if (e.target.closest('.reputation-value') || e.target.closest('.reputation-labels')) {
                return;
            }
            
            e.stopPropagation();
            reviewsModal.classList.add('show');
            
            try {
                const response = await fetch(`/api/user_reviews/{{ user_info['tg_id'] }}`);
                const reviews = await response.json();
                
                if (reviews.length > 0) {
                    reviewsList.innerHTML = '';
                    
                    reviews.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                    
                    reviews.forEach(review => {
                        const reviewItem = document.createElement('div');
                        reviewItem.className = 'review-item';
                        
                        const ratingClass = review.rating > 0 ? 'positive' : 'negative';
                        const ratingText = review.rating > 0 ? 'Положительный' : 'Отрицательный';
                        
                        reviewItem.innerHTML = `
                            <div class="review-header">
                                <div>
                                    <span class="review-rating ${ratingClass}">${ratingText}</span>
                                    <br>
                                    От 
                                    <span class="review-author">
                                        <a href="/profile/${review.from_user_id}" style="color: inherit;">
                                            ${review.from_user_name}
                                        </a>
                                    </span>
                                </div>
                                <div class="review-date">${new Date(review.created_at).toLocaleDateString()}</div>
                            </div>
                            <div class="review-text">${review.text || 'Без текста'}</div>
                        `;
                        
                        reviewsList.appendChild(reviewItem);
                    });
                } else {
                    reviewsList.innerHTML = '<div class="no-reviews">Нет отзывов</div>';
                }
            } catch (error) {
                console.error('Ошибка загрузки отзывов:', error);
                reviewsList.innerHTML = '<div class="no-reviews">Ошибка загрузки отзывов</div>';
            }
        });

        // Закрытие модального окна
        closeReviews.addEventListener('click', function() {
            reviewsModal.classList.remove('show');
        });

        reviewsModal.addEventListener('click', function(e) {
            if (e.target === reviewsModal) {
                reviewsModal.classList.remove('show');
            }
        });

        // Обработка выпадающего меню
        const menuButton = document.getElementById('menuButton');
        const dropdownMenu = document.getElementById('dropdownMenu');
        const shareReferral = document.getElementById('shareReferral');

        const avatarContainer = document.querySelector('.avatar-container');
        const adminCrownTooltip = document.querySelector('.admin-crown-tooltip');
        const moderatorHatTooltip = document.querySelector('.moderator-hat-tooltip');

        if (avatarContainer) {
            let tooltipTimeout;
            
            // Показ подсказки при наведении
            avatarContainer.addEventListener('mouseenter', function() {
                clearTimeout(tooltipTimeout);
                if (adminCrownTooltip) {
                    tooltipTimeout = setTimeout(() => {
                        adminCrownTooltip.classList.add('show');
                    }, 300);
                } else if (moderatorHatTooltip) {
                    tooltipTimeout = setTimeout(() => {
                        moderatorHatTooltip.classList.add('show');
                    }, 300);
                }
            });

            // Скрытие подсказки при уходе курсора
            avatarContainer.addEventListener('mouseleave', function() {
                clearTimeout(tooltipTimeout);
                if (adminCrownTooltip) {
                    adminCrownTooltip.classList.remove('show');
                } else if (moderatorHatTooltip) {
                    moderatorHatTooltip.classList.remove('show');
                }
            });

            // Показ/скрытие подсказки при клике (для мобильных устройств)
            avatarContainer.addEventListener('click', function(e) {
                e.stopPropagation();
                if (adminCrownTooltip) {
                    adminCrownTooltip.classList.toggle('show');
                } else if (moderatorHatTooltip) {
                    moderatorHatTooltip.classList.toggle('show');
                }
            });

            // Скрытие подсказки при клике вне области
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.avatar-container')) {
                    if (adminCrownTooltip) {
                        adminCrownTooltip.classList.remove('show');
                    } else if (moderatorHatTooltip) {
                        moderatorHatTooltip.classList.remove('show');
                    }
                }
            });
        }

        menuButton.addEventListener('click', function(e) {
            e.stopPropagation();
            dropdownMenu.classList.toggle('show');
        });

        document.addEventListener('click', function(e) {
            if (!e.target.closest('.header-icon') && !e.target.closest('.dropdown-menu')) {
                dropdownMenu.classList.remove('show');
            }
        });

        shareReferral.addEventListener('click', function(e) {
            e.stopPropagation();
            dropdownMenu.classList.remove('show');
            
            const referralLink = `https://t.me/test_tma8_bot?startapp=ref_{{ user_info["tg_id"] }}`;
            const message = `Покупай и продавай прямо в Телеграмме:\n\n${referralLink}`;
            
            if (window.Telegram && window.Telegram.WebApp) {
                if (window.Telegram.WebApp.openTelegramLink) {
                    window.Telegram.WebApp.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(message)}`);
                } else if (window.Telegram.WebApp.shareTelegram) {
                    window.Telegram.WebApp.shareTelegram({
                        text: message,
                        url: referralLink
                    });
                } else if (window.Telegram.WebApp.sendData) {
                    window.Telegram.WebApp.sendData(JSON.stringify({
                        action: 'share_referral',
                        text: message,
                        url: referralLink
                    }));
                } else {
                    fallbackShare(message);
                }
            } else {
                fallbackShare(message);
            }
        });

        function fallbackShare(message) {
            try {
                navigator.clipboard.writeText(message).then(function() {
                    showNotification('Реферальная ссылка скопирована в буфер обмена!', 'info');
                    window.open(`https://t.me/share/url?url=${encodeURIComponent(message)}`, '_blank');
                }).catch(function() {
                    prompt('Скопируйте реферальную ссылку:', message);
                });
            } catch (e) {
                prompt('Скопируйте реферальную ссылку:', message);
            }
        }

        convertTonToRub();
    });
</script>
{% endblock %}