{% extends 'base.html' %}

{% block style %}
<style>
    .header {
        position: sticky;
        top: 0;
        z-index: 100;
        background-color: var(--bg-color);
        padding: 12px 16px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .page-title {
        font-size: 20px;
        font-weight: bold;
    }

    .tabs-header {
        display: flex;
        width: 100%;
        border-bottom: 1px solid var(--border-color);
    }

    .tab {
        flex: 1;
        text-align: center;
        padding: 16px 0;
        font-size: 16px;
        font-weight: 500;
        color: var(--text-secondary);
        cursor: pointer;
        position: relative;
        border-bottom: 3px solid transparent;
        transition: all 0.3s ease;
    }

    .tab.active {
        color: var(--primary-color);
        border-bottom-color: var(--primary-color);
    }

    .tab-indicator {
        position: absolute;
        bottom: -3px;
        left: 0;
        height: 3px;
        width: 50%;
        background-color: var(--primary-color);
        transition: all 0.3s ease;
    }

    .add-button {
        position: fixed;
        bottom: 80px;
        right: 20px;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background-color: var(--primary-color);
        color: white;
        border: none;
        font-size: 24px;
        cursor: pointer;
        box-shadow: 0 4px 12px var(--shadow-color);
        z-index: 99;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .main-content {
        flex: 1;
        padding: 16px;
        min-height: calc(100vh - 180px);
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(165px, 1fr));
        gap: 16px;
    }

    .ad-card {
        background: linear-gradient(145deg, var(--card-bg), var(--secondary-color));
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 
            0 4px 12px var(--shadow-color),
            0 1px 3px rgba(0,0,0,0.1);
        cursor: pointer;
        height: 320px;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        border: 1px solid var(--border-color);
        position: relative;
        opacity: 0;
        transform: translateY(30px);
        animation: cardAppear 0.6s ease forwards;
    }

    @keyframes cardAppear {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .ad-card:hover {
        transform: translateY(-5px);
        box-shadow: 
            0 8px 25px var(--shadow-color),
            0 2px 6px rgba(0,0,0,0.1);
    }

    .ad-card.visible {
        opacity: 1;
        transform: translateY(0);
    }

    .no-ads-container {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        width: 100%;
    }

    .no-ads {
        color: #999;
        font-size: 18px;
        margin-top: 20px;
    }

    .ad-description {
        font-size: 12px;
        color: #999;
        text-overflow: ellipsis;
        white-space: nowrap;
        overflow: hidden;
        margin-top: 4px;
    }

    .ad-image {
        width: 100%;
        height: 180px;
        object-fit: cover;
        transition: transform 0.3s ease;
    }

    .ad-card:hover .ad-image {
        transform: scale(1.05);
    }

    .ad-details {
        padding: 14px;
        position: relative;
    }

    .ad-price {
        font-weight: bold;
        margin-bottom: 6px;
        color: var(--primary-color);
        font-size: 16px;
    }

    .ad-title {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 6px;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        line-height: 1.3;
        height: 2.6em;
    }

    .ad-location {
        font-size: 12px;
        color: #666;
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .ad-time {
        font-size: 11px;
        color: #999;
        font-weight: 500;
    }

    .ad-card.moderation {
        position: relative;
        opacity: 0.7;
    }

    .moderation-badge {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: bold;
        z-index: 10;
        pointer-events: none;
        white-space: nowrap;
    }

    .ad-card.moderation::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(255, 255, 255, 0.5);
        z-index: 5;
        pointer-events: none;
    }

    .ad-card.archived {
        position: relative;
        opacity: 0.7;
    }

    .archived-badge {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: bold;
        z-index: 10;
        pointer-events: none;
        white-space: nowrap;
    }

    .ad-card.archived::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(255, 255, 255, 0.5);
        z-index: 5;
        pointer-events: none;
    }

    .ad-card.reserved {
        position: relative;
        opacity: 0.7;
    }

    .reserved-badge {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: bold;
        z-index: 10;
        pointer-events: none;
        white-space: nowrap;
    }

    .ad-card.reserved::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(255, 255, 255, 0.5);
        z-index: 5;
        pointer-events: none;
    }

    .ad-actions {
        position: absolute;
        top: 10px;
        right: 10px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        z-index: 20;
    }

    .action-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .ad-action-btn {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: var(--card-bg);
        color: var(--primary-color);
        border: 2px solid var(--primary-color);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px var(--shadow-color);
    }

    .ad-action-btn:hover {
        transform: scale(1.1);
        background: var(--primary-color);
        color: white;
    }

    .ad-action-btn:active {
        transform: scale(0.95);
    }

    .toast {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: var(--primary-color);
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .toast.show {
        opacity: 1;
    }

    .loading-indicator {
        grid-column: 1 / -1;
        text-align: center;
        padding: 20px;
        color: #999;
        display: none;
    }

    .loading-indicator::after {
        content: '';
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-left: 10px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .ad-new-badge {
        position: absolute;
        top: 10px;
        left: 10px;
        background: linear-gradient(135deg, var(--primary-color), #6aa1ff);
        color: white;
        padding: 6px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: bold;
        z-index: 10;
        box-shadow: 0 2px 8px rgba(63, 136, 248, 0.3);
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }
</style>
{% endblock %}

{% block content %}
    <header class="header">
        <div class="page-title">Мои объявления</div>
    </header>

    <div class="tabs-header">
        <div class="tab active" data-tab="active">Активные</div>
        <div class="tab" data-tab="moderation">На проверке</div>
        <div class="tab" data-tab="archived">Архив</div>
    </div>

    <main class="main-content" id="mainContent">
        <!-- Активные объявления -->
        <div class="tab-content" id="activeTab">
            <div class="ads-grid" id="activeAdsGrid"></div>
            <div class="no-ads-container" id="activeNoAds" style="display: none;">
                <div class="no-ads">Нет активных объявлений</div>
            </div>
        </div>

        <!-- Объявления на проверке -->
        <div class="tab-content" id="moderationTab" style="display: none;">
            <div class="ads-grid" id="moderationAdsGrid"></div>
            <div class="no-ads-container" id="moderationNoAds" style="display: none;">
                <div class="no-ads">Нет объявлений на проверке</div>
            </div>
        </div>

        <!-- Архивные объявления -->
        <div class="tab-content" id="archivedTab" style="display: none;">
            <div class="ads-grid" id="archivedAdsGrid"></div>
            <div class="no-ads-container" id="archivedNoAds" style="display: none;">
                <div class="no-ads">Нет архивных объявлений</div>
            </div>
        </div>

        <div class="loading-indicator" id="loadingIndicator">
            Загрузка товаров...
        </div>
    </main>

    <button class="add-button" onclick="window.location.href='{{ url_for('add_product') }}'">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
    </button>

    <div class="toast" id="toast"></div>
{% endblock %}

{% block scripts %}
<script src="/static/js/price_conv.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', async () => {
        // Инициализация переменных для пагинации
        let currentPage = 1;
        let isLoading = false;
        let hasMore = true;
        let currentTab = "{{ request.query_params.get('tab', 'active') }}";
        
        // Устанавливаем активную вкладку
        document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('active');
            if (tab.dataset.tab === currentTab) {
                tab.classList.add('active');
            }
        });

        // Показываем только активную вкладку
        document.querySelectorAll('.tab-content').forEach(content => {
            content.style.display = 'none';
        });
        document.getElementById(`${currentTab}Tab`).style.display = 'block';

        // Обработчики кликов по вкладкам
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', (e) => {
                e.preventDefault();
                const tabName = tab.dataset.tab;
                currentTab = tabName;
                currentPage = 1;
                hasMore = true;
                
                // Обновляем UI
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.style.display = 'none';
                });
                document.getElementById(`${tabName}Tab`).style.display = 'block';
                
                // Очищаем предыдущие товары и загружаем новые
                document.getElementById(`${tabName}AdsGrid`).innerHTML = '';
                document.getElementById(`${tabName}NoAds`).style.display = 'none';
                
                // Обновляем URL без перезагрузки страницы
                history.pushState(null, '', `?tab=${tabName}`);
                
                loadProducts(currentPage, tabName);
            });
        });

        // Функция для загрузки товаров
        async function loadProducts(page, tab = 'active') {
            if (isLoading || !hasMore) return;
            
            isLoading = true;
            document.getElementById('loadingIndicator').style.display = 'block';
            
            try {
                const response = await fetch(`/api/user_review_products?page=${page}&tab=${tab}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const data = await response.json();
                
                if (data.products.length === 0) {
                    hasMore = false;
                    
                    // Показываем сообщение "Нет объявлений", если это первая страница
                    if (page === 1) {
                        document.getElementById(`${tab}NoAds`).style.display = 'block';
                    }
                } else {
                    renderProducts(data.products, tab);
                    currentPage = page;
                }
            } catch (error) {
                console.error('Error loading products:', error);
            } finally {
                isLoading = false;
                document.getElementById('loadingIndicator').style.display = 'none';
            }
        }

        // Функция для форматирования даты
        function formatDate(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                const day = date.getDate().toString().padStart(2, '0');
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const year = date.getFullYear().toString().slice(2);
                const hours = date.getHours().toString().padStart(2, '0');
                const minutes = date.getMinutes().toString().padStart(2, '0');
                return `${day}.${month}.${year} ${hours}:${minutes}`;
            } catch (e) {
                return dateString;
            }
        }

        // Функция для отрисовки товаров
        function renderProducts(products, tab) {
            const grid = document.getElementById(`${tab}AdsGrid`);
            
            products.forEach((product, index) => {
                const isReserved = product["reserved"] || false;
                const isModeration = tab === 'moderation';
                const isArchived = tab === 'archived';
                
                const productHtml = `
                    <div class="ads-container">
                        <div class="ad-card ${isReserved ? 'reserved' : ''} ${isModeration ? 'moderation' : ''} ${isArchived ? 'archived' : ''}" data-id="${product["product_id"]}" style="animation-delay: ${index * 0.1}s">
                            ${isReserved ? '<div class="reserved-badge">Забронировано</div>' : ''}
                            ${isModeration ? '<div class="moderation-badge">На проверке</div>' : ''}
                            ${isArchived ? '<div class="archived-badge">В архиве</div>' : ''}
                            
                            <img src="/${product["product_image_url"]}" class="ad-image" alt="${product["product_name"]}">
                            <div class="ad-details">
                                <div class="ad-title">${product["product_name"]}</div>
                                ${product.location ? `<div class="ad-location">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                        <circle cx="12" cy="10" r="3"></circle>
                                    </svg>
                                    ${product.location}
                                </div>` : ''}
                                <div class="ad-price">${product["product_price"]} TON</div>
                                <div class="ad-time">${formatDate(product["created_at"])}</div>
                            </div>
                            
                            <div class="ad-actions">
                                ${tab === 'active' && !isReserved ? `
                                    <div class="action-group">
                                        <button class="ad-action-btn archive-btn" data-id="${product["product_id"]}" title="В архив">
                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <polyline points="21 8 21 21 3 21 3 8"></polyline>
                                                <rect x="1" y="3" width="22" height="5"></rect>
                                                <line x1="10" y1="12" x2="14" y2="12"></line>
                                            </svg>
                                        </button>
                                    </div>
                                ` : ''}
                                
                                ${tab === 'archived' ? `
                                    <div class="action-group">
                                        <button class="ad-action-btn restore-btn" data-id="${product["product_id"]}" title="Восстановить">
                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                                                <polyline points="9 22 9 12 15 12 15 22"></polyline>
                                            </svg>
                                        </button>
                                    </div>
                                ` : ''}
                                
                                <div class="action-group">
                                    <button class="ad-action-btn delete-btn" data-id="${product["product_id"]}" title="Удалить">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="3 6 5 6 21 6"></polyline>
                                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                            <line x1="10" y1="11" x2="10" y2="17"></line>
                                            <line x1="14" y1="11" x2="14" y2="17"></line>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                grid.insertAdjacentHTML('beforeend', productHtml);
            });
            
            // Активируем наблюдение за видимостью карточек
            setupIntersectionObserver();
            setupProductClickHandlers();
        }

        // Intersection Observer для анимации появления карточек
        function setupIntersectionObserver() {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('visible');
                    }
                });
            }, {
                threshold: 0.1,
                rootMargin: '50px'
            });

            document.querySelectorAll('.ad-card').forEach(card => {
                observer.observe(card);
            });
        }

        function setupProductClickHandlers() {
            document.addEventListener('click', (e) => {
                // Обработка клика по карточке (но игнорируем клики по кнопкам)
                const card = e.target.closest('.ad-card');
                if (card && !e.target.closest('.ad-actions') && 
                    !e.target.closest('.archive-btn') && 
                    !e.target.closest('.delete-btn') && 
                    !e.target.closest('.restore-btn')) {
                    
                    const productId = card.dataset.id;
                    window.location.href = `/ads/${productId}`;
                }
            });
        }

        // Обработчик скролла для бесконечной подгрузки
        window.addEventListener('scroll', () => {
            const { scrollTop, scrollHeight, clientHeight } = document.documentElement;
            
            if (scrollTop + clientHeight >= scrollHeight - 100 && !isLoading && hasMore) {
                loadProducts(currentPage + 1, currentTab);
            }
        });

        // Обработчики действий с объявлениями
        document.addEventListener('click', async (e) => {
            // Удаление объявления
            if (e.target.closest('.delete-btn')) {
                const btn = e.target.closest('.delete-btn');
                const adId = btn.dataset.id;
                
                if (confirm('Вы уверены, что хотите удалить это объявление?')) {
                    try {
                        const response = await fetch(`/delete_product/${adId}`, {
                            method: 'POST'
                        });
                        
                        if (response.ok) {
                            showToast('Объявление удалено');
                            btn.closest('.ad-card').remove();
                            
                            // Проверяем, остались ли еще объявления
                            const currentTab = document.querySelector('.tab.active').dataset.tab;
                            const grid = document.getElementById(`${currentTab}AdsGrid`);
                            if (grid.children.length === 0) {
                                document.getElementById(`${currentTab}NoAds`).style.display = 'block';
                            }
                        } else {
                            showToast('Ошибка при удалении', 'error');
                        }
                    } catch (error) {
                        showToast('Ошибка при удалении', 'error');
                    }
                }
            }
            
            // Отправка в архив
            if (e.target.closest('.archive-btn')) {
                const btn = e.target.closest('.archive-btn');
                const adId = btn.dataset.id;
                
                try {
                    const response = await fetch(`/archive_product/${adId}`, {
                        method: 'POST'
                    });
                    
                    if (response.ok) {
                        showToast('Объявление отправлено в архив');
                        btn.closest('.ad-card').remove();
                        
                        // Проверяем, остались ли еще активные объявления
                        const activeGrid = document.getElementById('activeAdsGrid');
                        if (activeGrid.children.length === 0) {
                            document.getElementById('activeNoAds').style.display = 'block';
                        }
                    } else {
                        showToast('Ошибка при архивировании', 'error');
                    }
                } catch (error) {
                    showToast('Ошибка при архивировании', 'error');
                }
            }
            
            // Восстановление из архива
            if (e.target.closest('.restore-btn')) {
                const btn = e.target.closest('.restore-btn');
                const adId = btn.dataset.id;
                
                try {
                    const response = await fetch(`/restore_product/${adId}`, {
                        method: 'POST'
                    });
                    
                    if (response.ok) {
                        showToast('Объявление восстановлено');
                        btn.closest('.ad-card').remove();
                        
                        // Проверяем, остались ли еще архивные объявления
                        const archivedGrid = document.getElementById('archivedAdsGrid');
                        if (archivedGrid.children.length === 0) {
                            document.getElementById('archivedNoAds').style.display = 'block';
                        }
                    } else {
                        showToast('Ошибка при восстановлении', 'error');
                    }
                } catch (error) {
                    showToast('Ошибка при восстановлении', 'error');
                }
            }
        });

        // Показ уведомления о проверке после добавления товара
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('moderation') === 'true') {
            showToast('Товар отправлен на проверку');
            history.replaceState(null, '', window.location.pathname);
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Загружаем первую страницу товаров
        loadProducts(currentPage, currentTab);
    });
</script>
{% endblock %}