{% extends 'base.html' %}

{% block style %}
<style>
    .header {
        position: sticky;
        top: 0;
        z-index: 100;
        background-color: var(--bg-color);
        padding: 12px 16px;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .admin-title {
        font-size: 20px;
        font-weight: bold;
        margin-bottom: 16px;
        text-align: center;
    }

    .tabs-header {
        display: flex;
        width: 100%;
        border-bottom: 1px solid var(--border-color);
        position: relative;
    }

    .tab {
        flex: 1;
        text-align: center;
        padding: 16px 0;
        font-size: 16px;
        font-weight: 500;
        color: var(--text-secondary);
        cursor: pointer;
        position: relative;
        transition: all 0.3s ease;
        text-decoration: none;
    }

    .tab.active {
        color: var(--primary-color);
    }

    .tab-indicator {
        position: absolute;
        bottom: -1px;
        left: 0;
        height: 3px;
        width: 50%;
        background-color: var(--primary-color);
        transition: all 0.3s ease;
    }

    .content-container {
        padding: 16px;
    }

    .report-item, .product-item {
        background-color: var(--card-bg);
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 12px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }

    .item-id {
        font-weight: bold;
        color: var(--primary-color);
    }

    .item-time {
        font-size: 12px;
        color: var(--secondary-text);
    }

    .report-reason {
        margin: 12px 0;
        padding: 12px;
        background-color: rgba(255, 0, 0, 0.1);
        border-left: 3px solid var(--error-color);
        border-radius: 4px;
    }

    .product-info {
        margin: 12px 0;
        padding: 12px;
        background-color: var(--bg-color);
        border-radius: 4px;
    }

    .product-title {
        font-weight: bold;
        margin-bottom: 8px;
    }

    .product-price {
        color: var(--primary-color);
        font-weight: bold;
    }

    .product-description {
        margin: 8px 0;
    }

    .product-image {
        width: 30vh;
        border-radius: 4px;
        margin-top: 8px;
    }

    .item-actions {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
    }

    .view-button {
        padding: 8px 16px;
        background-color: var(--primary-color);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        font-size: 14px;
    }

    .approve-button {
        padding: 8px 16px;
        background-color: var(--success-color);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }

    .reject-button {
        padding: 8px 16px;
        background-color: var(--error-color);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }

    .no-items {
        text-align: center;
        padding: 40px 20px;
        color: var(--secondary-text);
    }

    .hidden {
        display: none;
    }

    /* Стили для модального окна отклонения */
    #reject-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    #reject-modal .modal-content {
        background-color: var(--card-bg);
        padding: 20px;
        border-radius: 8px;
        width: 80%;
        max-width: 500px;
    }

    #reject-modal h3 {
        margin-top: 0;
    }

    #reject-reason {
        width: 100%;
        min-height: 100px;
        padding: 8px;
        margin-bottom: 16px;
        border-radius: 4px;
        border: 1px solid var(--border-color);
    }

    #reject-modal .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
    }

    #reject-modal .modal-button {
        padding: 8px 16px;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    #cancel-reject {
        background-color: var(--secondary-text);
    }

    #confirm-reject {
        background-color: var(--error-color);
    }

    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .modal-content {
        background-color: var(--card-bg);
        padding: 20px;
        border-radius: 8px;
        width: 80%;
        max-width: 500px;
    }

    .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        margin-top: 16px;
    }

    .modal-button {
        padding: 8px 16px;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .form-group {
        margin-bottom: 16px;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
    }

    .form-group select, 
    .form-group textarea {
        width: 100%;
        padding: 8px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        background-color: var(--bg-color);
        color: var(--text-color);
    }

    .form-group textarea {
        min-height: 80px;
        resize: vertical;
    }

    .user-item {
        background-color: var(--card-bg);
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 12px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .search-container input {
        background-color: var(--bg-color);
        color: var(--text-color);
        border: 1px solid var(--border-color);
        resize: none;
    }

    .filter-buttons button {
        padding: 8px 16px;
        background-color: var(--bg-color);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        cursor: pointer;
    }

    .filter-buttons button.active {
        background-color: var(--primary-color);
        color: white;
    }

    .dropdown {
        position: relative;
        display: inline-block;
    }

    .dropdown-toggle {
        padding: 8px 16px;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 18px;
        color: var(--primary-color);
    }

    .dropdown-menu {
        display: none;
        position: absolute;
        right: 0;
        background-color: var(--card-bg);
        min-width: 160px;
        box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        z-index: 1;
        border-radius: 4px;
        overflow: hidden;
    }

    .dropdown:hover .dropdown-menu {
        display: block;
    }

    .dropdown-item {
        width: 100%;
        padding: 8px 16px;
        text-align: left;
        background: none;
        border: none;
        cursor: pointer;
    }

    .dropdown-item:hover {
        background-color: var(--bg-color);
    }

    /* Но это может повлиять на другие функциональности, поэтому лучше так: */
    textarea::-webkit-resizer {
        display: none; /* Скрывает индикатор изменения размера в WebKit-браузерах */
    }

    .review-item {
        background-color: var(--card-bg);
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 16px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .review-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }

    .review-meta {
        flex: 1;
    }

    .review-deal-id {
        font-weight: bold;
        color: var(--primary-color);
    }

    .review-date {
        font-size: 12px;
        color: var(--secondary-text);
    }

    .review-rating {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
    }

    .review-rating.positive {
        background-color: rgba(46, 204, 113, 0.1);
        color: var(--success-color);
    }

    .review-rating.negative {
        background-color: rgba(231, 76, 60, 0.1);
        color: var(--error-color);
    }

    .review-users {
        display: flex;
        gap: 16px;
        margin-bottom: 12px;
        font-size: 14px;
    }

    .review-user {
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .user-label {
        color: var(--secondary-text);
    }

    .user-link {
        color: var(--primary-color);
        text-decoration: none;
    }

    .review-text {
        padding: 12px;
        background-color: var(--bg-color);
        border-radius: 4px;
        margin-bottom: 16px;
        line-height: 1.5;
    }

    .review-actions {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
    }

    .action-button {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 8px 16px;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
    }

    .action-button.approve {
        background-color: var(--success-color);
        color: white;
    }

    .action-button.reject {
        background-color: var(--error-color);
        color: white;
    }

    .action-button:hover {
        opacity: 0.9;
    }

    .no-items {
        text-align: center;
        padding: 40px 20px;
        color: var(--secondary-text);
    }

    .no-items svg {
        margin-bottom: 16px;
    }

    .no-items p {
        margin: 0;
        font-size: 16px;
    }

    .tabs-dropdown {
        position: relative;
        width: 100%;
        margin-bottom: 16px;
    }

    .tabs-dropdown-btn {
        width: 100%;
        padding: 12px 16px;
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 16px;
        font-weight: 500;
        text-align: left;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .tabs-dropdown-btn::after {
        content: "▼";
        font-size: 12px;
        margin-left: 8px;
    }

    .tabs-dropdown-content {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        width: 100%;
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        z-index: 100;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .tabs-dropdown-content.show {
        display: block;
    }

    .dropdown-tab {
        padding: 12px 16px;
        cursor: pointer;
        border-bottom: 1px solid var(--border-color);
    }

    .dropdown-tab:last-child {
        border-bottom: none;
    }

    .dropdown-tab.active {
        color: var(--secondary-text);
        font-weight: bold;
    }

    .deal-item {
        background-color: var(--card-bg);
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 12px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .deal-info {
        margin: 12px 0;
        padding: 12px;
        background-color: var(--bg-color);
        border-radius: 4px;
        font-size: 14px;
        line-height: 1.6;
    }

    .deal-info div {
        margin-bottom: 6px;
    }

    .cancel-reason {
        margin-top: 8px;
        padding: 8px;
        background-color: rgba(255, 0, 0, 0.1);
        border-left: 3px solid var(--error-color);
        border-radius: 4px;
    }

    .actions-button {
        padding: 8px 16px;
        background-color: var(--primary-color);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }

    .modal-actions-column {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-top: 16px;
    }

    .action-option {
        width: 100%;
        background-color: var(--primary-color);
        text-align: center;
    }

    .deal-info-modal {
        padding: 12px;
        background-color: var(--bg-color);
        border-radius: 4px;
        margin-bottom: 16px;
    }

    .hidden {
        display: none;
    }

    .product-gallery-container {
        position: relative;
        width: 100%;
        height: 300px;
        border-radius: 8px;
        margin-bottom: 12px;
        overflow: hidden;
        background-color: #f5f5f5;
    }

    .product-gallery {
        position: relative;
        width: 100%;
        height: 100%;
    }

    .product-gallery-slide {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        transition: opacity 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #f5f5f5;
        cursor: pointer;
    }

    .product-gallery-slide.active {
        opacity: 1;
    }

    .product-gallery-slide img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
    }

    .product-gallery-nav {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 40px;
        height: 40px;
        background-color: rgba(0, 0, 0, 0.5);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 10;
        border: none;
        color: white;
        font-size: 20px;
        transition: all 0.2s ease;
    }

    .product-gallery-nav:hover {
        background-color: rgba(0, 0, 0, 0.7);
    }

    .product-gallery-prev {
        left: 10px;
    }

    .product-gallery-next {
        right: 10px;
    }

    .product-gallery-nav:disabled {
        opacity: 0.3;
        cursor: not-allowed;
    }

    .product-gallery-pagination {
        position: absolute;
        bottom: 10px;
        left: 0;
        right: 0;
        display: flex;
        justify-content: center;
        gap: 6px;
        z-index: 10;
    }

    .product-gallery-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background-color: rgba(255, 255, 255, 0.5);
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .product-gallery-dot.active {
        background-color: white;
        transform: scale(1.2);
    }

    /* Полноэкранный просмотр */
    .product-fullscreen-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.9);
        z-index: 1000;
        justify-content: center;
        align-items: center;
        touch-action: none;
    }

    .product-fullscreen-image-container {
        position: relative;
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .product-fullscreen-image {
        max-width: 100%;
        max-height: 100%;
        transform-origin: center center;
        transition: transform 0.1s ease-out;
        user-select: none;
        -webkit-user-drag: none;
    }

    .product-close-fullscreen {
        position: absolute;
        top: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.5);
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 1001;
    }

    .product-close-fullscreen svg {
        width: 24px;
        height: 24px;
        fill: white;
    }
</style>
{% endblock %}

{% block content %}
<header class="header">
    <div class="admin-title">Панель администратора</div>
    
    <!-- Changed tabs header to dropdown -->
    <div class="tabs-dropdown">
        <button class="tabs-dropdown-btn">
            {% if active_tab == 'reports' %}Жалобы на чаты
            {% elif active_tab == 'moderation' %}Модерация объявлений
            {% elif active_tab == 'users' %}Пользователи
            {% elif active_tab == 'reviews' %}Отзывы
            {% elif active_tab == 'deals' %}Сделки
            {% else %}Жалобы на чаты{% endif %}
        </button>
        <div class="tabs-dropdown-content" id="tabsDropdown">
            <div class="dropdown-tab {% if active_tab == 'reports' %}active{% endif %}" data-tab="reports">Жалобы на чаты</div>
            <div class="dropdown-tab {% if active_tab == 'moderation' %}active{% endif %}" data-tab="moderation">Модерация объявлений</div>
            <div class="dropdown-tab {% if active_tab == 'users' %}active{% endif %}" data-tab="users">Пользователи</div>
            <div class="dropdown-tab {% if active_tab == 'reviews' %}active{% endif %}" data-tab="reviews">Отзывы</div>
            <div class="dropdown-tab {% if active_tab == 'deals' %}active{% endif %}" data-tab="deals">Сделки</div>
        </div>
    </div>
</header>

<main class="content-container">
    <!-- Секция жалоб на чаты -->
    <div id="reportsTab" {% if active_tab != 'reports' %}class="hidden"{% endif %}>
        {% if reports %}
            {% for report in reports %}
            <div class="report-item">
                <div class="item-header">
                    <div>
                        <span class="item-id">Чат #{{ report.chat_id }}</span>
                        <span>от пользователя {{ report.reporter_first_name }} ({{ report.reporter_id }})</span>
                    </div>
                    <div class="item-time">{{ report.created_at.strftime('%d.%m.%Y %H:%M') }}</div>
                </div>
                
                <div class="report-reason">
                    {{ report.reason }}
                </div>
                
                <div class="item-actions">
                    <a href="/admin/chat/{{ report.chat_id }}" class="view-button">Перейти в чат</a>
                    <button class="approve-button" data-action="resolve" data-id="{{ report.id | int }}">Решено</button>
                    <button class="reject-button" data-action="block" data-id="{{ report.id | int }}">Заблокировать</button>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="no-items">Нет активных жалоб</div>
        {% endif %}
    </div>

    <div id="usersTab" {% if active_tab != 'users' %}class="hidden"{% endif %}>
        <div class="search-container" style="margin-bottom: 16px;">
            <input type="text" id="userSearch" placeholder="Поиск пользователей..." style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--border-color);">
        </div>
        
        <div class="filter-buttons" style="display: flex; gap: 8px; margin-bottom: 16px;">
            <button class="filter-button active" data-filter="all">Все</button>
            <button class="filter-button" data-filter="blocked">Заблокированные</button>
            <button class="filter-button" data-filter="active">Активные</button>
        </div>
        
        {% if users %}
            {% for user in users %}
            <div class="user-item" data-user-id="{{ user.tg_id }}" data-blocked="{{ user.is_blocked }}">
                <div class="item-header">
                    <div>
                        <span class="item-id">@{{ user.first_name }}</span><br>
                        <!-- <span class="item-id">ID: {{ user.tg_id }}</span> -->
                        <span>ID: {{ user.tg_id }}</span>
                    </div>
                    <div class="item-actions">
                        <div class="dropdown">
                            <button class="dropdown-toggle">
                                <svg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                    <!-- Верхняя точка -->
                                    <circle cx="10" cy="5" r="2" fill="black"/>
                                    
                                    <!-- Средняя точка -->
                                    <circle cx="10" cy="10" r="2" fill="black"/>
                                    
                                    <!-- Нижняя точка -->
                                    <circle cx="10" cy="15" r="2" fill="black"/>
                                </svg>
                            </button>
                            <div class="dropdown-menu">
                                {% if user.is_blocked %}
                                    <button class="dropdown-item unblock-user" data-id="{{ user.tg_id }}">Разблокировать</button>
                                {% else %}
                                    <button class="dropdown-item block-user" data-id="{{ user.tg_id }}">Заблокировать</button>
                                {% endif %}
                            </div>
                        </div>
                        <a href="/profile/{{ user.tg_id }}" class="view-button">Профиль</a>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="no-items">Нет пользователей</div>
        {% endif %}
    </div>

    <!-- Секция модерации объявлений -->
    <div id="moderationTab" {% if active_tab != 'moderation' %}class="hidden"{% endif %}>
        {% if moderation_products %}
            {% for product in moderation_products %}
            <div class="product-item" data-product-id="{{ product[4] }}">
                <div class="item-header">
                    <div>
                        <span class="item-id">Объявление #{{ product[4] }}</span>
                        <span>от пользователя {{ product[7] }} ({{ product[1] }})</span>
                    </div>
                    <div class="item-time">{{ product[5].strftime('%d.%m.%Y %H:%M') }}</div>
                </div>
                
                <!-- Галерея фотографий -->
                <div class="product-gallery-container">
                    {% if product[3] %}
                        {% set images = product[3]|from_json %}
                        <div class="product-gallery">
                            {% for image in images %}
                            <div class="product-gallery-slide {% if loop.first %}active{% endif %}">
                                <img src="/{{ image }}" alt="Фото товара">
                            </div>
                            {% endfor %}
                            
                            <button class="product-gallery-nav product-gallery-prev" {% if images|length <= 1 %}disabled{% endif %}>&#10094;</button>
                            <button class="product-gallery-nav product-gallery-next" {% if images|length <= 1 %}disabled{% endif %}>&#10095;</button>
                            
                            <div class="product-gallery-pagination">
                                {% for image in images %}
                                <div class="product-gallery-dot {% if loop.first %}active{% endif %}" data-index="{{ loop.index0 }}"></div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}
                </div>
                
                <div class="product-info">
                    <div class="product-title">{{ product[0] }}</div>
                    <div class="product-price">{{ product[1] }} ₽</div>
                    <div class="product-category">Категория: {{ product[6] }}</div>
                    <div class="product-description">{{ product[2] }}</div>
                </div>
                
                <div class="item-actions">
                    <button class="approve-button" data-action="approve" data-id="{{ product[4] }}">Одобрить</button>
                    <button class="reject-button" data-action="reject" data-id="{{ product[4] }}">Отклонить</button>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="no-items">Нет объявлений на модерации</div>
        {% endif %}
    </div>

    <!-- Полноэкранный просмотр фотографий -->
    <div class="product-fullscreen-overlay" id="productFullscreenOverlay">
        <div class="product-fullscreen-image-container">
            <button class="product-close-fullscreen" id="productCloseFullscreen">
                <svg viewBox="0 0 24 24">
                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                </svg>
            </button>
            <img class="product-fullscreen-image" id="productFullscreenImage" src="" alt="">
        </div>
    </div>

    <!-- Секция модерации отзывов -->
    <div id="reviewsTab" {% if active_tab != 'reviews' %}class="hidden"{% endif %}>
        {% if reviews %}
            {% for review in reviews %}
            <div class="review-item">
                <div class="review-header">
                    <div class="review-meta">
                        <div class="review-deal-id">Сделка #{{ review.deal_id }}</div>
                        <div class="review-date">{{ review.created_at.strftime('%d.%m.%Y %H:%M') }}</div>
                    </div>
                    <div class="review-rating {% if review.rating > 0 %}positive{% else %}negative{% endif %}">
                        {% if review.rating > 0 %}+1{% else %}-1{% endif %}
                    </div>
                </div>
                
                <div class="review-users">
                    <div class="review-user">
                        <span class="user-label">От:</span>
                        <a href="/profile/{{ review.from_user_id }}" class="user-link">
                            {{ review.from_user_first_name }} (ID: {{ review.from_user_id }})
                        </a>
                        <!-- <a href="/profile/{{ review.from_user_id }}" class="user-link">
                            ID: {{ review.from_user_id }}
                        </a> -->
                    </div>
                    <div class="review-user">
                        <span class="user-label">Кому:</span>
                        <!-- <a href="/profile/{{ review.to_user_id }}" class="user-link">
                            ID: {{ review.to_user_id }}
                        </a> -->
                        <a href="/profile/{{ review.to_user_id }}" class="user-link">
                            {{ review.to_user_first_name }} (ID: {{ review.to_user_id }})
                        </a>
                    </div>
                </div>
                
                <div class="review-text">
                    {{ review.text }}
                </div>
                
                <div class="review-actions">
                    <button class="action-button approve" data-action="approve-review" data-id="{{ review.id }}">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Одобрить
                    </button>
                    <button class="action-button reject" data-action="reject-review" data-id="{{ review.id }}">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Отклонить
                    </button>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="no-items">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="var(--secondary-text)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M12 8V12M12 16H12.01" stroke="var(--secondary-text)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <p>Нет отзывов на модерации</p>
            </div>
        {% endif %}
    </div>

    <div id="dealsTab" {% if active_tab != 'deals' %}class="hidden"{% endif %}>
        {% if pending_deals %}
            {% for deal in pending_deals %}
            <!-- В разделе dealsTab, внутри цикла for deal in pending_deals -->
            <div class="deal-item" data-deal-id="{{ deal.id }}">
                <div class="item-header">
                    <div>
                        <span class="item-id">Сделка #{{ deal.id }}</span>
                        <span>Товар: {{ deal.product_name }}</span>
                    </div>
                    <div class="item-time">{{ deal.created_at.strftime('%d.%m.%Y %H:%M') }}</div>
                </div>
                
                <div class="deal-info">
                    <!-- <div><strong>Продавец:</strong> {{ deal.seller_first_name }} (ID: {{ deal.seller_id }})</div>
                    <div><strong>Покупатель:</strong> {{ deal.buyer_first_name }} (ID: {{ deal.buyer_id }})</div> -->
                    <div><strong>Продавец:</strong> {{ deal.seller_first_name }} (ID: {{ deal.seller_id }})</div>
                    <div><strong>Покупатель:</strong> {{ deal.buyer_first_name }} (ID: {{ deal.buyer_id }})</div>
                    <div><strong>Сумма:</strong> {{ deal.amount }} {{ deal.currency.upper() }}</div>
                    <div><strong>Статус:</strong> {{ deal.status }}</div>
                    <div><strong>Тип оплаты:</strong> {% if deal.currency == 'meet' %}При встрече{% else %}Онлайн{% endif %}</div>
                    {% if deal.currency != 'meet' %}
                        <div class="cancel-reason">
                            <strong>Причина отмены:</strong> {{ deal.cancel_reason }}
                        </div>
                        <div><strong>Запросил отмену:</strong> {% if deal.cancel_request_by == deal.seller_id %}Продавец{% else %}Покупатель{% endif %}</div>
                    {% endif %}
                </div>
                
                <div class="item-actions">
                    {% if deal.currency == 'meet' and deal.pending_cancel %}
                        <button class="approve-button" data-action="confirm-meet-deal" data-id="{{ deal.id }}">Подтвердить</button>
                        <button class="reject-button" data-action="cancel-meet-deal" data-id="{{ deal.id }}">Отменить</button>
                    {% else %}
                        <button class="actions-button" data-action="deal-actions" data-id="{{ deal.id }}">Действия</button>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="no-items">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="var(--secondary-text)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M12 8V12M12 16H12.01" stroke="var(--secondary-text)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <p>Нет сделок, ожидающих отмены</p>
            </div>
        {% endif %}
    </div>

    <!-- Модальное окно действий со сделкой -->
    <div id="deal-actions-modal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <!-- Основные действия -->
            <div id="main-actions">
                <h3 style="margin-top: 0;">Действия со сделкой</h3>
                <div id="deal-info-container" class="deal-info-modal" style="margin-bottom: 16px; font-size: 14px;">
                    <!-- Информация о сделке будет подгружаться динамически -->
                </div>
                
                <div class="modal-actions-column">
                    <button class="modal-button action-option" data-action="complete-deal" style="background-color: var(--primary-color);">
                        Завершить сделку
                    </button>
                    <button class="modal-button action-option" data-action="give-time" style="background-color: var(--primary-color);">
                        Дать время на завершение
                    </button>
                    <button class="modal-button" id="cancel-deal-action" style="background-color: var(--secondary-text); margin-top: 16px;">
                        Отмена
                    </button>
                </div>
            </div>
            
            <!-- Форма завершения сделки -->
            <div id="complete-deal-actions" class="hidden">
                <h3 style="margin-top: 0;">Завершить сделку</h3>
                <div class="form-group">
                    <label for="complete-reason">Причина решения</label>
                    <textarea id="complete-reason" rows="3" placeholder="Опишите причину решения" style="width: 100%;"></textarea>
                </div>
                <div style="display: flex; gap: 8px; margin-top: 12px;">
                    <button class="modal-button" id="complete-for-seller" style="background-color: var(--success-color); flex: 1;">
                        В пользу продавца
                    </button>
                    <button class="modal-button" id="complete-for-buyer" style="background-color: var(--primary-color); flex: 1;">
                        Вернуть средства покупателю
                    </button>
                </div>
                <button class="modal-button" id="back-to-main-actions" style="background-color: var(--secondary-text); margin-top: 12px;">
                    Назад
                </button>
            </div>
            
            <!-- Форма продления времени -->
            <div id="give-time-actions" class="hidden">
                <h3 style="margin-top: 0;">Дать время на завершение</h3>
                <div class="form-group">
                    <label for="time-hours">Дополнительное время</label>
                    <select id="time-hours" class="form-select" style="width: 100%;">
                        <option value="1">1 час</option>
                        <option value="3">3 часа</option>
                        <option value="6">6 часов</option>
                        <option value="12">12 часов</option>
                        <option value="24" selected>24 часа</option>
                        <option value="48">48 часов</option>
                        <option value="72">72 часа</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="time-reason">Комментарий (необязательно)</label>
                    <textarea id="time-reason" rows="2" placeholder="Можете оставить комментарий" style="width: 100%;"></textarea>
                </div>
                <button class="modal-button" id="confirm-give-time" style="background-color: var(--primary-color); margin-top: 8px;">
                    Подтвердить
                </button>
                <button class="modal-button" id="back-to-main-actions-2" style="background-color: var(--secondary-text); margin-top: 8px;">
                    Назад
                </button>
            </div>
        </div>
    </div>
</main>

<!-- Модальное окно только для отклонения объявлений -->
<div id="reject-modal">
    <div class="modal-content">
        <h3>Укажите причину отклонения</h3>
        <textarea id="reject-reason" placeholder="Введите причину отклонения объявления..."></textarea>
        <div class="modal-actions">
            <button id="cancel-reject" class="modal-button">Отмена</button>
            <button id="confirm-reject" class="modal-button">Отправить</button>
        </div>
    </div>
</div>

<!-- Добавляем после существующего модального окна отклонения -->
<div id="block-modal" class="modal">
    <div class="modal-content">
        <h3>Заблокировать пользователя</h3>
        
        <!-- Блок выбора пользователя (будет скрыт при блокировке из вкладки пользователей) -->
        <div id="user-selection-block" class="form-group hidden">
            <label for="block-user">Выберите пользователя:</label>
            <select id="block-user" class="form-select">
                <option value="">-- Выберите пользователя --</option>
                <option value="user1"><span id="user1-username"></span> (ID=<span id="user1-id"></span>)</option>
                <option value="user2"><span id="user2-username"></span> (ID=<span id="user2-id"></span>)</option>
            </select>
        </div>
        
        <!-- Блок информации о пользователе (показывается при блокировке из вкладки пользователей) -->
        <div id="user-info-block" class="form-group hidden">
            <div><strong>Пользователь:</strong> <span id="selected-user-info"></span></div>
            <input type="hidden" id="selected-user-id">
        </div>
        
        <div class="form-group">
            <label for="block-duration">Срок блокировки:</label>
            <select id="block-duration" class="form-select">
                <option value="1h">1 час</option>
                <option value="1d">1 день</option>
                <option value="3d">3 дня</option>
                <option value="7d">7 дней</option>
                <option value="30d">1 месяц</option>
                <option value="90d">3 месяца</option>
                <option value="365d">1 год</option>
                <option value="permanent">Навсегда</option>
            </select>
        </div>
        <div class="form-group">
            <label for="block-reason">Причина (опционально):</label>
            <textarea id="block-reason" rows="3" placeholder="Укажите причину блокировки"></textarea>
        </div>
        <div class="modal-actions">
            <button id="cancel-block" class="modal-button">Отмена</button>
            <button id="confirm-block" class="modal-button" style="background-color: var(--error-color);">Заблокировать</button>
        </div>
    </div>
</div>

<!-- Модальное окно отклонения отзыва -->
<div id="reject-review-modal" class="modal">
    <div class="modal-content">
        <h3>Укажите причину отклонения отзыва</h3>
        <textarea id="reject-review-reason" placeholder="Введите причину отклонения отзыва..."></textarea>
        <div class="modal-actions">
            <button id="cancel-review-reject" class="modal-button">Отмена</button>
            <button id="confirm-review-reject" class="modal-button" style="background-color: var(--error-color);">Отклонить</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Инициализация индикатора вкладок
        const tabsHeader = document.querySelector('.tabs-header');
        const tabIndicator = document.getElementById('tabIndicator');

        const dropdownBtn = document.querySelector('.tabs-dropdown-btn');
        const dropdownContent = document.getElementById('tabsDropdown');
        
        dropdownBtn.addEventListener('click', () => {
            dropdownContent.classList.toggle('show');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.tabs-dropdown')) {
                dropdownContent.classList.remove('show');
            }
        });

        // Обработчик поиска пользователей
        document.getElementById('userSearch').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const userItems = document.querySelectorAll('.user-item');
            
            userItems.forEach(item => {
                const userName = item.querySelector('.item-id').textContent.toLowerCase();
                const userId = item.querySelector('span:not(.item-id)').textContent.toLowerCase();
                
                if (userName.includes(searchTerm) || userId.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        });

        document.querySelectorAll('.filter-button').forEach(button => {
            button.addEventListener('click', function() {
                // Удаляем класс active у всех кнопок
                document.querySelectorAll('.filter-button').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Добавляем класс active текущей кнопке
                this.classList.add('active');
                
                const filter = this.dataset.filter;
                filterUsers(filter);
            });
        });

        // Функция фильтрации пользователей
        function filterUsers(filter) {
            const userItems = document.querySelectorAll('.user-item');
            
            userItems.forEach(item => {
                const isBlocked = item.dataset.blocked === 'True';
                
                switch(filter) {
                    case 'all':
                        item.style.display = 'block';
                        break;
                    case 'blocked':
                        item.style.display = isBlocked ? 'block' : 'none';
                        break;
                    case 'active':
                        item.style.display = isBlocked ? 'none' : 'block';
                        break;
                }
            });
        }

        // Tab switching logic
        const tabs = document.querySelectorAll('.dropdown-tab');
        
        tabs.forEach(tab => {
            tab.addEventListener('click', (e) => {
                e.preventDefault();
                const tabName = tab.dataset.tab;
                
                // Update URL without reload
                const url = new URL(window.location.href);
                url.searchParams.set('tab', tabName);
                window.history.pushState({}, '', url);
                
                // Update dropdown button text
                dropdownBtn.textContent = tab.textContent;
                dropdownContent.classList.remove('show');
                
                // Hide all content and show selected
                document.querySelectorAll('.content-container > div').forEach(content => {
                    content.classList.add('hidden');
                });
                document.getElementById(`${tabName}Tab`).classList.remove('hidden');
                
                // Update active tab in dropdown
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                window.location.href = `/admin/chat_reports?tab=${tabName}`;
            });
        });

        // Функция для открытия модального окна блокировки
        function openBlockModal(options = {}) {
            const modal = document.getElementById('block-modal');
            const userSelectionBlock = document.getElementById('user-selection-block');
            const userInfoBlock = document.getElementById('user-info-block');
            
            // Сбрасываем предыдущие значения
            document.getElementById('block-reason').value = '';
            document.getElementById('block-duration').value = '1h';
            
            // Настройка отображения в зависимости от контекста
            if (options.fromUsersTab) {
                // Блокировка из вкладки пользователей
                userSelectionBlock.classList.add('hidden');
                userInfoBlock.classList.remove('hidden');
                document.getElementById('selected-user-info').textContent = 
                    `${options.userName} (ID: ${options.userId})`;
                document.getElementById('selected-user-id').value = options.userId;
            } else {
                // Блокировка из чата
                userSelectionBlock.classList.remove('hidden');
                userInfoBlock.classList.add('hidden');
                
                // Загружаем информацию о пользователях чата
                fetch(`/admin/get_chat_info/${options.chatId}`)
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('user1-id').textContent = data.user1_id;
                        document.getElementById('user2-id').textContent = data.user2_id;
                        document.getElementById('user1-username').textContent = data.user1_username;
                        document.getElementById('user2-username').textContent = data.user2_username;
                        document.getElementById('block-user').dataset.chatId = options.chatId;
                        document.getElementById('block-user').dataset.reportId = options.reportId;
                    });
            }
            
            modal.style.display = 'flex';
        }

        // Обработчик для кнопки блокировки из вкладки пользователей
        document.addEventListener('click', function(event) {
            if (event.target.matches('.block-user')) {
                const userId = event.target.dataset.id;
                const userName = event.target.closest('.user-item').querySelector('.item-id').textContent;
                
                openBlockModal({
                    fromUsersTab: true,
                    userId: userId,
                    userName: userName
                });
            }
        });

        // Обработчик для кнопки блокировки из чата
        document.addEventListener('click', function(event) {
            if (event.target.matches('[data-action="block"]')) {
                const reportId = event.target.dataset.id;
                const chatId = event.target.closest('.report-item').querySelector('.item-id').textContent.replace('Чат #', '');
                
                openBlockModal({
                    fromUsersTab: false,
                    chatId: chatId,
                    reportId: reportId
                });
            }
        });

        // Обработчик подтверждения блокировки
        document.getElementById('confirm-block').addEventListener('click', async function() {
            const modal = document.getElementById('block-modal');
            const duration = document.getElementById('block-duration').value;
            const reason = document.getElementById('block-reason').value;
            
            // Определяем ID пользователя в зависимости от контекста
            let userId;
            if (document.getElementById('user-selection-block').classList.contains('hidden')) {
                // Блокировка из вкладки пользователей
                userId = document.getElementById('selected-user-id').value;
            } else {
                // Блокировка из чата
                const userSelect = document.getElementById('block-user');
                userId = userSelect.value === 'user1' 
                    ? parseInt(document.getElementById('user1-id').textContent)
                    : parseInt(document.getElementById('user2-id').textContent);
            }
            
            try {
                const response = await fetch('/admin/block_user', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: userId,
                        duration: duration,
                        reason: reason
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.status === "success") {
                        modal.style.display = 'none';
                        window.location.reload();
                    }
                } else {
                    alert('Ошибка при блокировке пользователя');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Ошибка при блокировке пользователя');
            }
        });

        // Обработчик отмены блокировки
        document.getElementById('cancel-block').addEventListener('click', function() {
            document.getElementById('block-modal').style.display = 'none';
        });

        // Обработчик разблокировки пользователя
        // Улучшенный обработчик разблокировки пользователя
        document.addEventListener('click', async function(event) {
            if (event.target.closest('.unblock-user')) {
                const button = event.target.closest('.unblock-user');
                const userId = button.dataset.id;
                
                try {
                    const response = await fetch('/admin/block_user', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            user_id: userId,
                            block: false  // Важно: указываем, что это разблокировка
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.status === "success") {
                            // Обновляем статус пользователя без перезагрузки страницы
                            const userItem = button.closest('.user-item');
                            userItem.dataset.blocked = 'False';
                            
                            // Обновляем меню действий
                            const dropdownMenu = button.closest('.dropdown-menu');
                            dropdownMenu.innerHTML = `
                                <button class="dropdown-item block-user" data-id="${userId}">Заблокировать</button>
                            `;
                            
                            // Если активен фильтр "Заблокированные", скрываем пользователя
                            const activeFilter = document.querySelector('.filter-button.active').dataset.filter;
                            if (activeFilter === 'blocked') {
                                userItem.style.display = 'none';
                            }
                        }
                    } else {
                        alert('Ошибка при разблокировке пользователя');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Ошибка при разблокировке пользователя');
                }
            }
        });

        // Остальные обработчики (для других вкладок админки)
        document.addEventListener('click', async function(event) {
            if (event.target.matches('[data-action="approve"]')) {
                const productId = event.target.dataset.id;
                
                try {
                    const response = await fetch(`/admin/approve_product/${productId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.status === "success") {
                            event.target.closest('.product-item').remove();
                            checkEmptyContainer('moderationTab', 'Нет объявлений на модерации');
                        }
                    } else {
                        alert('Ошибка при одобрении объявления');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Ошибка при одобрении объявления');
                }
            }
            
            if (event.target.matches('[data-action="resolve"]')) {
                const id = event.target.dataset.id;
                try {
                    const response = await fetch(`/admin/resolve_report/${id}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.status === "success") {
                            event.target.closest('.report-item').remove();
                            checkEmptyContainer('reportsTab', 'Нет активных жалоб');
                        }
                    } else {
                        alert('Ошибка при обработке запроса');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Ошибка при обработке запроса');
                }
            }
            
            if (event.target.matches('[data-action="reject"]')) {
                const productId = event.target.dataset.id;
                document.getElementById('reject-modal').dataset.productId = productId;
                document.getElementById('reject-modal').style.display = 'flex';
            }
        });

        // Функция для проверки пустого контейнера
        function checkEmptyContainer(containerId, message) {
            const container = document.getElementById(containerId);
            if (container.querySelectorAll('.report-item, .product-item, .review-item, .deal-item').length === 0) {
                container.innerHTML = `<div class="no-items">${message}</div>`;
            }
        }

        // Обработка модального окна отклонения
        document.getElementById('cancel-reject').addEventListener('click', function() {
            document.getElementById('reject-modal').style.display = 'none';
            document.getElementById('reject-reason').value = '';
        });

        document.getElementById('confirm-reject').addEventListener('click', async function() {
            const productId = document.getElementById('reject-modal').dataset.productId;
            const reason = document.getElementById('reject-reason').value.trim();
            
            if (!reason) {
                alert('Пожалуйста, укажите причину отклонения');
                return;
            }

            try {
                const response = await fetch(`/admin/reject_product/${productId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ reason })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.status === "success") {
                        document.getElementById('reject-modal').style.display = 'none';
                        document.getElementById('reject-reason').value = '';
                        const item = document.querySelector(`.product-item[data-product-id="${productId}"]`);
                        if (item) {
                            item.remove();
                            checkEmptyContainer('moderationTab', 'Нет объявлений на модерации');
                        }
                    }
                } else {
                    alert('Ошибка при отклонении объявления');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Ошибка при отклонении объявления');
            }
        });

        // Обработчики для других вкладок админки
        document.addEventListener('click', async function(event) {
            if (event.target.matches('[data-action="approve-review"]')) {
                const reviewId = event.target.dataset.id;
                
                try {
                    const response = await fetch(`/admin/moderate_review/${reviewId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ approve: true })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.status === "success") {
                            event.target.closest('.review-item').remove();
                            checkEmptyContainer('reviewsTab', 'Нет отзывов на модерации');
                        }
                    } else {
                        alert('Ошибка при одобрении отзыва');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Ошибка при одобрении отзыва');
                }
            }
            
            if (event.target.matches('[data-action="reject-review"]')) {
                const reviewId = event.target.dataset.id;
                document.getElementById('reject-review-modal').dataset.reviewId = reviewId;
                document.getElementById('reject-review-modal').style.display = 'flex';
            }
        });

        // Обработка модального окна отклонения отзыва
        document.getElementById('cancel-review-reject').addEventListener('click', function() {
            document.getElementById('reject-review-modal').style.display = 'none';
            document.getElementById('reject-review-reason').value = '';
        });

        document.getElementById('confirm-review-reject').addEventListener('click', async function() {
            const reviewId = document.getElementById('reject-review-modal').dataset.reviewId;
            const reason = document.getElementById('reject-review-reason').value.trim();
            
            if (!reason) {
                alert('Пожалуйста, укажите причину отклонения');
                return;
            }

            try {
                const response = await fetch(`/admin/moderate_review/${reviewId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        approve: false,
                        reason: reason
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.status === "success") {
                        document.getElementById('reject-review-modal').style.display = 'none';
                        document.getElementById('reject-review-reason').value = '';
                        const item = document.querySelector(`.review-item[data-id="${reviewId}"]`);
                        if (item) {
                            item.remove();
                            checkEmptyContainer('reviewsTab', 'Нет отзывов на модерации');
                        }
                    }
                } else {
                    alert('Ошибка при отклонении отзыва');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Ошибка при отклонении отзыва');
            }
        });

        // Обработчики для вкладки сделок
        document.addEventListener('click', function(event) {
            if (event.target.matches('[data-action="deal-actions"]')) {
                const dealId = event.target.dataset.id;
                openDealActionsModal(dealId);
            }
        });

        // Функция для открытия модального окна действий со сделкой
        function openDealActionsModal(dealId) {
            const modal = document.getElementById('deal-actions-modal');
            modal.style.display = 'flex';
            modal.dataset.dealId = dealId;
            
            // Загружаем информацию о сделке
            fetch(`/admin/get_deal_info/${dealId}`)
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('deal-info-container');
                    container.innerHTML = `
                        <div><strong>Товар:</strong> ${data.product_name}</div>
                        <div><strong>Сумма:</strong> ${data.amount} ${data.currency.toUpperCase()}</div>
                        <div><strong>Продавец:</strong> ID ${data.seller_id}</div>
                        <div><strong>Покупатель:</strong> ID ${data.buyer_id}</div>
                        ${data.pending_cancel ? `
                            <div style="margin-top: 8px; color: var(--error-color);">
                                <strong>Запрос на отмену:</strong> ${data.cancel_reason}
                            </div>
                        ` : ''}
                    `;
                });
        }

        // Закрытие модального окна сделок
        document.getElementById('cancel-deal-action').addEventListener('click', function() {
            document.getElementById('deal-actions-modal').style.display = 'none';
        });

        // Остальные обработчики для сделок
        document.addEventListener('click', function(event) {
            if (event.target.matches('.action-option')) {
                const action = event.target.dataset.action;
                document.getElementById('main-actions').classList.add('hidden');
                
                if (action === 'complete-deal') {
                    document.getElementById('complete-deal-actions').classList.remove('hidden');
                } else if (action === 'give-time') {
                    document.getElementById('give-time-actions').classList.remove('hidden');
                }
            }
        });

        // Возврат к основным действиям
        function backToMainActions() {
            document.getElementById('complete-deal-actions').classList.add('hidden');
            document.getElementById('give-time-actions').classList.add('hidden');
            document.getElementById('main-actions').classList.remove('hidden');
        }

        document.getElementById('back-to-main-actions').addEventListener('click', backToMainActions);
        document.getElementById('back-to-main-actions-2').addEventListener('click', backToMainActions);

        // Завершение сделки в пользу продавца
        document.getElementById('complete-for-seller').addEventListener('click', function() {
            const dealId = document.getElementById('deal-actions-modal').dataset.dealId;
            const reason = document.getElementById('complete-reason').value.trim();
            
            if (!reason) {
                alert('Пожалуйста, укажите причину решения');
                return;
            }
            
            fetch(`/admin/complete_deal/${dealId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'for_seller',
                    reason: reason
                })
            }).then(response => {
                if (response.ok) {
                    const data = response.json();
                    if (data.status === "success") {
                        document.getElementById('deal-actions-modal').style.display = 'none';
                        const item = document.querySelector(`.deal-item[data-deal-id="${dealId}"]`);
                        if (item) {
                            item.remove();
                            checkEmptyContainer('dealsTab', 'Нет сделок, ожидающих отмены');
                        }
                    }
                } else {
                    alert('Ошибка при завершении сделки');
                }
            });
        });

        // Возврат средств покупателю
        document.getElementById('complete-for-buyer').addEventListener('click', function() {
            const dealId = document.getElementById('deal-actions-modal').dataset.dealId;
            const reason = document.getElementById('complete-reason').value.trim();
            
            if (!reason) {
                alert('Пожалуйста, укажите причину решения');
                return;
            }
            
            fetch(`/admin/complete_deal/${dealId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'for_buyer',
                    reason: reason
                })
            }).then(response => {
                if (response.ok) {
                    const data = response.json();
                    if (data.status === "success") {
                        document.getElementById('deal-actions-modal').style.display = 'none';
                        const item = document.querySelector(`.deal-item[data-deal-id="${dealId}"]`);
                        if (item) {
                            item.remove();
                            checkEmptyContainer('dealsTab', 'Нет сделок, ожидающих отмены');
                        }
                    }
                } else {
                    alert('Ошибка при завершении сделки');
                }
            });
        });

        // Дать время на завершение
        document.getElementById('confirm-give-time').addEventListener('click', function() {
            const dealId = document.getElementById('deal-actions-modal').dataset.dealId;
            const hours = document.getElementById('time-hours').value;
            const reason = document.getElementById('time-reason').value;
            
            fetch(`/admin/give_more_time/${dealId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    hours: hours,
                    reason: reason
                })
            }).then(response => {
                if (response.ok) {
                    const data = response.json();
                    if (data.status === "success") {
                        document.getElementById('deal-actions-modal').style.display = 'none';
                        const item = document.querySelector(`.deal-item[data-deal-id="${dealId}"]`);
                        if (item) {
                            item.remove();
                            checkEmptyContainer('dealsTab', 'Нет сделок, ожидающих отмены');
                        }
                    }
                } else {
                    alert('Ошибка при обновлении сделки');
                }
            });
        });

        document.querySelectorAll('.product-gallery').forEach(gallery => {
            const slides = gallery.querySelectorAll('.product-gallery-slide');
            const prevBtn = gallery.querySelector('.product-gallery-prev');
            const nextBtn = gallery.querySelector('.product-gallery-next');
            const dots = gallery.querySelectorAll('.product-gallery-dot');
            let currentSlide = 0;

            function showSlide(index) {
                slides.forEach((slide, i) => {
                    slide.classList.toggle('active', i === index);
                });
                
                dots.forEach((dot, i) => {
                    dot.classList.toggle('active', i === index);
                });
                
                if (prevBtn) prevBtn.disabled = index === 0;
                if (nextBtn) nextBtn.disabled = index === slides.length - 1;
                
                currentSlide = index;
            }

            if (prevBtn) {
                prevBtn.addEventListener('click', () => {
                    if (currentSlide > 0) {
                        showSlide(currentSlide - 1);
                    }
                });
            }

            if (nextBtn) {
                nextBtn.addEventListener('click', () => {
                    if (currentSlide < slides.length - 1) {
                        showSlide(currentSlide + 1);
                    }
                });
            }

            dots.forEach(dot => {
                dot.addEventListener('click', () => {
                    showSlide(parseInt(dot.dataset.index));
                });
            });

            // Открытие в полноэкранном режиме
            slides.forEach(slide => {
                slide.addEventListener('click', () => {
                    const activeImg = slides[currentSlide].querySelector('img');
                    if (activeImg) {
                        document.getElementById('productFullscreenImage').src = activeImg.src;
                        document.getElementById('productFullscreenOverlay').style.display = 'flex';
                        document.body.style.overflow = 'hidden';
                    }
                });
            });
        });

        // Закрытие полноэкранного режима
        document.getElementById('productCloseFullscreen')?.addEventListener('click', () => {
            document.getElementById('productFullscreenOverlay').style.display = 'none';
            document.body.style.overflow = '';
        });

        document.getElementById('productFullscreenOverlay')?.addEventListener('click', (e) => {
            if (e.target === document.getElementById('productFullscreenOverlay')) {
                document.getElementById('productFullscreenOverlay').style.display = 'none';
                document.body.style.overflow = '';
            }
        });

        // Закрытие по ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.getElementById('productFullscreenOverlay').style.display === 'flex') {
                document.getElementById('productFullscreenOverlay').style.display = 'none';
                document.body.style.overflow = '';
            }
        });
    });
</script>
{% endblock %}