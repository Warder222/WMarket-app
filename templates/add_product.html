{% extends "base.html" %}

{% block style %}
<style>
    .add-product-container {
        max-width: 600px;
        margin: 20px auto;
        padding: 20px;
    }

    .add-product-title {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 20px;
        text-align: center;
        color: var(--primary-color);
    }

    .form-group {
        margin-bottom: 15px;
        position: relative;
    }

    .form-label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
    }

    .form-input, .form-select, .form-textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background-color: var(--card-bg);
        color: var(--text-color);
        font-size: 16px;
    }

    .form-textarea {
        min-height: 100px;
        resize: vertical;
    }

    .form-input:focus, .form-select:focus, .form-textarea:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(63, 136, 248, 0.2);
    }

    .submit-btn {
        width: 100%;
        padding: 12px;
        background-color: var(--primary-color);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        margin-top: 10px;
    }

    .submit-btn:hover {
        opacity: 0.9;
    }

    .submit-btn:disabled {
        background-color: var(--border-color);
        cursor: not-allowed;
    }

    .submit-btn:disabled:hover {
        opacity: 1;
    }

    .image-upload-section {
        margin-bottom: 20px;
    }

    .image-upload-label {
        display: block;
        width: 100%;
        padding: 20px;
        background-color: var(--secondary-color);
        color: var(--text-color);
        text-align: center;
        border-radius: 12px;
        border: 2px dashed var(--border-color);
        cursor: pointer;
        transition: all 0.3s ease;
        margin-bottom: 20px;
    }

    .image-upload-label:hover {
        background-color: var(--hover-color);
        border-color: var(--primary-color);
    }

    .image-upload-label:active {
        transform: scale(0.98);
    }

    .images-counter {
        text-align: center;
        margin-bottom: 20px;
        color: var(--text-secondary);
        font-size: 14px;
        font-weight: 500;
    }

    .images-counter .remaining {
        color: var(--primary-color);
        font-weight: 600;
    }

    .image-gallery {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        gap: 10px;
        margin-bottom: 15px;
    }

    .gallery-item {
        position: relative;
        width: 100%;
        aspect-ratio: 1;
        border-radius: 8px;
        overflow: hidden;
        background-color: var(--card-bg);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .gallery-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }

    .remove-image-btn {
        position: absolute;
        top: 2px;
        right: 2px;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background-color: rgba(255, 0, 0, 0.8);
        color: white;
        border: none;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        font-size: 14px;
        line-height: 1;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .gallery-item:hover .remove-image-btn {
        opacity: 1;
    }

    .image-actions {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        display: flex;
        justify-content: space-between;
        background-color: rgba(0, 0, 0, 0.5);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .gallery-item:hover .image-actions {
        opacity: 1;
    }

    .move-left-btn, .move-right-btn {
        background: none;
        border: none;
        color: white;
        padding: 2px 5px;
        cursor: pointer;
        font-weight: bold;
        font-size: 12px;
    }

    .move-left-btn:disabled, .move-right-btn:disabled {
        opacity: 0.3;
        cursor: not-allowed;
    }

    .gallery-item.dragging {
        opacity: 0.6;
        transform: scale(0.95);
    }

    .upload-icon {
        font-size: 24px;
        margin-bottom: 8px;
    }

    .upload-text {
        font-size: 16px;
        font-weight: 500;
    }

    .file-input {
        display: none;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ –≥–æ—Ä–æ–¥–∞ */
    .location-input-container {
        position: relative;
    }

    .cities-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        border-top: none;
        border-radius: 0 0 8px 8px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
        box-shadow: 0 4px 12px var(--shadow-color);
    }

    .cities-dropdown.active {
        display: block;
    }

    .city-option {
        padding: 10px 15px;
        cursor: pointer;
        border-bottom: 1px solid var(--border-color);
        transition: background-color 0.2s;
    }

    .city-option:hover {
        background-color: var(--hover-color);
    }

    .city-option:last-child {
        border-bottom: none;
    }

    .city-option.highlighted {
        background-color: var(--primary-color);
        color: white;
    }

    .location-hint {
        font-size: 12px;
        color: var(--text-secondary);
        margin-top: 5px;
    }

    .rub-price {
        margin-top: 5px;
        font-size: 14px;
        color: var(--text-secondary);
        text-align: right;
    }

    .rub-price .value {
        font-weight: 600;
        color: var(--primary-color);
    }

    .rub-price.loading {
        opacity: 0.7;
    }

    @media (max-width: 480px) {
        .image-gallery {
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 8px;
        }
        
        .image-upload-label {
            padding: 16px;
            margin-bottom: 16px;
        }

        .cities-dropdown {
            max-height: 150px;
        }
    }
</style>
{% endblock %}

{% block content %}
<main>
    <div class="add-product-container">
        <h1 class="add-product-title">–î–æ–±–∞–≤–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</h1>
        <form id="add-product-form" enctype="multipart/form-data">
            <div class="form-group">
                <label class="form-label" for="category">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                <select class="form-select" id="category" name="category" required>
                    {% for cat in categories %}
                        <option value="{{ cat }}">{{ cat }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label class="form-label" for="product_name">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</label>
                <input class="form-input" type="text" id="product_name" name="product_name" required>
            </div>

            <div class="form-group">
                <label class="form-label" for="product_price">–¶–µ–Ω–∞ (TON)</label>
                <input class="form-input" type="text" id="product_price" name="product_price" min="0.1" step="0.1" pattern="^\d+(\.\d{1,2})?$" required>
                <div id="rubPriceDisplay" class="rub-price">
                    ‚âà <span class="value">0</span> ‚ÇΩ
                </div>
            </div>

            <div class="form-group">
                <label class="form-label" for="location">–ì–æ—Ä–æ–¥</label>
                <div class="location-input-container">
                    <input class="form-input" type="text" id="location" name="location" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞..." autocomplete="off">
                    <div id="citiesDropdown" class="cities-dropdown"></div>
                </div>
                <div class="location-hint">–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ –∏–∑ —Å–ø–∏—Å–∫–∞ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ</div>
            </div>

            <div class="form-group">
                <label class="form-label" for="product_description">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                <textarea class="form-textarea" id="product_description" name="product_description" required></textarea>
            </div>

            <div class="form-group">
                <div class="image-upload-section">
                    <label for="product_images" class="image-upload-label">
                        <div class="upload-icon">üì∑</div>
                        <div class="upload-text">–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏</div>
                    </label>
                    <input type="file" id="product_images" name="product_images" accept="image/*" multiple class="file-input">
                    <div class="images-counter" id="images-counter">–û—Å—Ç–∞–ª–æ—Å—å: <span class="remaining">10</span></div>
                    
                    <div id="imageGallery" class="image-gallery"></div>
                </div>
            </div>

            <button type="submit" class="submit-btn">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
        </form>
    </div>
</main>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const imageInput = document.getElementById('product_images');
        const imageGallery = document.getElementById('imageGallery');
        const imagesCounter = document.getElementById('images-counter');
        const priceInput = document.getElementById('product_price');
        const rubPriceDisplay = document.getElementById('rubPriceDisplay');
        const rubPriceValue = rubPriceDisplay.querySelector('.value');
        const locationInput = document.getElementById('location');
        const citiesDropdown = document.getElementById('citiesDropdown');
        const maxImages = 10;
        let uploadedImages = [];
        let currentTonRate = null;
        let allCities = []; // –ë—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–æ —Å —Å–µ—Ä–≤–µ—Ä–∞
        let filteredCities = [];
        let selectedCityIndex = -1;

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –≥–æ—Ä–æ–¥–æ–≤ —Å —Å–µ—Ä–≤–µ—Ä–∞
        async function loadCities() {
            try {
                const response = await fetch('/api/get_cities');
                const data = await response.json();
                if (data.cities) {
                    allCities = data.cities;
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≥–æ—Ä–æ–¥–æ–≤:', error);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –≥–æ—Ä–æ–¥–æ–≤
        function filterCities(searchTerm) {
            if (!searchTerm) {
                return allCities.slice(0, 10); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 10 –≥–æ—Ä–æ–¥–æ–≤
            }
            
            const term = searchTerm.toLowerCase();
            return allCities.filter(city => 
                city.toLowerCase().includes(term)
            ).slice(0, 10); // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º 10 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
        function showCitiesDropdown(cities) {
            citiesDropdown.innerHTML = '';
            
            if (cities.length === 0) {
                citiesDropdown.classList.remove('active');
                return;
            }
            
            cities.forEach((city, index) => {
                const option = document.createElement('div');
                option.className = 'city-option';
                option.textContent = city;
                option.dataset.value = city;
                
                if (index === selectedCityIndex) {
                    option.classList.add('highlighted');
                }
                
                option.addEventListener('click', function() {
                    locationInput.value = this.dataset.value;
                    citiesDropdown.classList.remove('active');
                    selectedCityIndex = -1;
                });
                
                citiesDropdown.appendChild(option);
            });
            
            citiesDropdown.classList.add('active');
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–æ–ª—è –≤–≤–æ–¥–∞ –≥–æ—Ä–æ–¥–∞
        locationInput.addEventListener('input', function() {
            const searchTerm = this.value.trim();
            filteredCities = filterCities(searchTerm);
            selectedCityIndex = -1;
            showCitiesDropdown(filteredCities);
        });

        locationInput.addEventListener('focus', function() {
            if (this.value.trim() === '') {
                filteredCities = filterCities('');
                showCitiesDropdown(filteredCities);
            }
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        document.addEventListener('click', function(e) {
            if (!locationInput.contains(e.target) && !citiesDropdown.contains(e.target)) {
                citiesDropdown.classList.remove('active');
                selectedCityIndex = -1;
            }
        });

        // –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –≤—ã–ø–∞–¥–∞—é—â–µ–º—É —Å–ø–∏—Å–∫—É —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
        locationInput.addEventListener('keydown', function(e) {
            if (!citiesDropdown.classList.contains('active')) return;

            const options = citiesDropdown.querySelectorAll('.city-option');
            
            switch(e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    selectedCityIndex = Math.min(selectedCityIndex + 1, options.length - 1);
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    selectedCityIndex = Math.max(selectedCityIndex - 1, -1);
                    break;
                case 'Enter':
                    e.preventDefault();
                    if (selectedCityIndex >= 0 && options[selectedCityIndex]) {
                        locationInput.value = options[selectedCityIndex].dataset.value;
                        citiesDropdown.classList.remove('active');
                        selectedCityIndex = -1;
                    }
                    break;
                case 'Escape':
                    citiesDropdown.classList.remove('active');
                    selectedCityIndex = -1;
                    break;
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É
            options.forEach((option, index) => {
                option.classList.toggle('highlighted', index === selectedCityIndex);
            });
        });

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –≥–æ—Ä–æ–¥–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        loadCities();

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫—É—Ä—Å–∞ TON/RUB
        async function getTonToRubRate() {
            try {
                const response = await fetch('/get_ton_to_rub_rate');
                const data = await response.json();
                
                if (response.ok && data.rate) {
                    currentTonRate = data.rate;
                    return data.rate;
                } else {
                    throw new Error(data.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫—É—Ä—Å');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∫—É—Ä—Å–∞ TON/RUB:', error);
                rubPriceDisplay.innerHTML = '–ö—É—Ä—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω';
                return null;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ü–µ–Ω—ã –≤ —Ä—É–±–ª—è—Ö
        function updateRubPrice(tonPrice) {
            if (!currentTonRate || !tonPrice) {
                rubPriceValue.textContent = '0';
                return;
            }

            const rubPrice = tonPrice * currentTonRate;
            rubPriceValue.textContent = rubPrice.toFixed(2);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ü–µ–Ω—ã –≤ TON
        function validateAndFormatTonPrice(value) {
            // –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å–∏–º–≤–æ–ª—ã, –∫—Ä–æ–º–µ —Ü–∏—Ñ—Ä –∏ —Ç–æ—á–∫–∏
            let cleaned = value.replace(/[^\d.]/g, '');
            
            // –£–¥–∞–ª—è–µ–º –ª–∏—à–Ω–∏–µ —Ç–æ—á–∫–∏ (–æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—É—é)
            const parts = cleaned.split('.');
            if (parts.length > 2) {
                cleaned = parts[0] + '.' + parts.slice(1).join('');
            }
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–Ω–∞–∫–æ–≤ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π –¥–æ 2
            if (parts.length === 2) {
                cleaned = parts[0] + '.' + parts[1].slice(0, 2);
            }
            
            return cleaned;
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–≤–æ–¥–∞ —Ü–µ–Ω—ã
        priceInput.addEventListener('input', function(e) {
            const formattedValue = validateAndFormatTonPrice(this.value);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
            if (formattedValue !== this.value) {
                this.value = formattedValue;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–µ–Ω—É –≤ —Ä—É–±–ª—è—Ö
            const tonPrice = parseFloat(formattedValue) || 0;
            updateRubPrice(tonPrice);
        });

        // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Ñ–æ–∫—É—Å–∞
        priceInput.addEventListener('blur', function(e) {
            let value = this.value.trim();
            
            if (value === '') {
                this.value = '0.1';
                value = '0.1';
            }
            
            const numericValue = parseFloat(value) || 0;
            
            if (numericValue < 0.1) {
                this.value = '0.1';
                showNotification('–¶–µ–Ω–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–Ω—å—à–µ 0.1 TON', 'info');
            } else if (numericValue > 100000000) {
                this.value = '100000000';
                showNotification('–¶–µ–Ω–∞ –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–µ–≤—ã—à–∞—Ç—å 100 –º–ª–Ω TON', 'info');
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–µ–Ω—É –≤ —Ä—É–±–ª—è—Ö –ø–æ—Å–ª–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
            updateRubPrice(parseFloat(this.value) || 0);
        });

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫—É—Ä—Å –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        getTonToRubRate().then(rate => {
            if (rate) {
                console.log('–ö—É—Ä—Å TON/RUB –∑–∞–≥—Ä—É–∂–µ–Ω:', rate);
            }
        });

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        function updateImagesCounter() {
            const remaining = maxImages - uploadedImages.length;
            imagesCounter.innerHTML = `–û—Å—Ç–∞–ª–æ—Å—å: <span class="remaining">${remaining}</span>`;
            imageInput.disabled = remaining <= 0;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞ –≥–∞–ª–µ—Ä–µ–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        function createGalleryItem(file, imageId) {
            return new Promise((resolve) => {
                const reader = new FileReader();

                reader.onload = function(event) {
                    const galleryItem = document.createElement('div');
                    galleryItem.className = 'gallery-item';
                    galleryItem.dataset.id = imageId;
                    galleryItem.draggable = true;

                    const img = document.createElement('img');
                    img.src = event.target.result;
                    img.alt = 'Preview';
                    img.file = file; // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ —Ñ–∞–π–ª

                    const removeBtn = document.createElement('button');
                    removeBtn.type = 'button';
                    removeBtn.className = 'remove-image-btn';
                    removeBtn.textContent = '√ó';
                    removeBtn.title = '–£–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é';

                    const actions = document.createElement('div');
                    actions.className = 'image-actions';
                    
                    const leftBtn = document.createElement('button');
                    leftBtn.type = 'button';
                    leftBtn.className = 'move-left-btn';
                    leftBtn.textContent = '‚Üê';
                    leftBtn.title = '–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–ª–µ–≤–æ';
                    
                    const rightBtn = document.createElement('button');
                    rightBtn.type = 'button';
                    rightBtn.className = 'move-right-btn';
                    rightBtn.textContent = '‚Üí';
                    rightBtn.title = '–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–ø—Ä–∞–≤–æ';
                    
                    actions.appendChild(leftBtn);
                    actions.appendChild(rightBtn);

                    galleryItem.appendChild(img);
                    galleryItem.appendChild(removeBtn);
                    galleryItem.appendChild(actions);
                    
                    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–¥–∞–ª–µ–Ω–∏—è
                    removeBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        removeImage(imageId);
                    });

                    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
                    leftBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        moveImageLeft(imageId);
                    });

                    rightBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        moveImageRight(imageId);
                    });

                    // Drag and drop —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª
                    galleryItem.addEventListener('dragstart', handleDragStart);
                    galleryItem.addEventListener('dragover', handleDragOver);
                    galleryItem.addEventListener('dragenter', handleDragEnter);
                    galleryItem.addEventListener('dragleave', handleDragLeave);
                    galleryItem.addEventListener('drop', handleDrop);
                    galleryItem.addEventListener('dragend', handleDragEnd);

                    resolve(galleryItem);
                };

                reader.readAsDataURL(file);
            });
        }

        // Drag and drop handlers
        function handleDragStart(e) {
            this.classList.add('dragging');
            e.dataTransfer.setData('text/plain', this.dataset.id);
        }

        function handleDragOver(e) {
            e.preventDefault();
        }

        function handleDragEnter(e) {
            e.preventDefault();
            this.classList.add('drag-over');
        }

        function handleDragLeave() {
            this.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            
            const draggedId = e.dataTransfer.getData('text/plain');
            const targetId = this.dataset.id;
            
            if (draggedId !== targetId) {
                moveImageToPosition(draggedId, targetId);
            }
        }

        function handleDragEnd() {
            this.classList.remove('dragging');
            document.querySelectorAll('.gallery-item').forEach(item => {
                item.classList.remove('drag-over');
            });
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        function moveImageLeft(imageId) {
            const items = Array.from(imageGallery.querySelectorAll('.gallery-item'));
            const currentIndex = items.findIndex(item => item.dataset.id === imageId);
            
            if (currentIndex > 0) {
                const prevItem = items[currentIndex - 1];
                imageGallery.insertBefore(items[currentIndex], prevItem);
                updateImagesOrder();
            }
        }

        function moveImageRight(imageId) {
            const items = Array.from(imageGallery.querySelectorAll('.gallery-item'));
            const currentIndex = items.findIndex(item => item.dataset.id === imageId);
            
            if (currentIndex < items.length - 1) {
                const nextItem = items[currentIndex + 1];
                imageGallery.insertBefore(nextItem, items[currentIndex]);
                updateImagesOrder();
            }
        }

        function moveImageToPosition(draggedId, targetId) {
            const draggedItem = imageGallery.querySelector(`[data-id="${draggedId}"]`);
            const targetItem = imageGallery.querySelector(`[data-id="${targetId}"]`);
            
            if (draggedItem && targetItem) {
                const allItems = Array.from(imageGallery.querySelectorAll('.gallery-item'));
                const draggedIndex = allItems.indexOf(draggedItem);
                const targetIndex = allItems.indexOf(targetItem);
                
                if (draggedIndex < targetIndex) {
                    imageGallery.insertBefore(draggedItem, targetItem.nextSibling);
                } else {
                    imageGallery.insertBefore(draggedItem, targetItem);
                }
                
                updateImagesOrder();
            }
        }

        function updateImagesOrder() {
            const items = Array.from(imageGallery.querySelectorAll('.gallery-item'));
            uploadedImages = items.map(item => {
                return uploadedImages.find(img => img.id === item.dataset.id);
            }).filter(img => img !== undefined);
            
            updateMoveButtons();
        }

        function updateMoveButtons() {
            const items = imageGallery.querySelectorAll('.gallery-item');
            items.forEach((item, index) => {
                const leftBtn = item.querySelector('.move-left-btn');
                const rightBtn = item.querySelector('.move-right-btn');
                
                if (leftBtn) leftBtn.disabled = index === 0;
                if (rightBtn) rightBtn.disabled = index === items.length - 1;
            });
        }

        function removeImage(imageId) {
            // –£–¥–∞–ª—è–µ–º –∏–∑ –º–∞—Å—Å–∏–≤–∞
            uploadedImages = uploadedImages.filter(img => img.id !== imageId);
            
            // –£–¥–∞–ª—è–µ–º –∏–∑ DOM
            const elementToRemove = document.querySelector(`.gallery-item[data-id="${imageId}"]`);
            if (elementToRemove) {
                imageGallery.removeChild(elementToRemove);
            }
            
            updateImagesCounter();
            updateMoveButtons();
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–æ–≤
        imageInput.addEventListener('change', async function(e) {
            if (e.target.files && e.target.files.length > 0) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
                const totalImages = uploadedImages.length + e.target.files.length;
                if (totalImages > maxImages) {
                    showNotification(`–ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–µ –±–æ–ª–µ–µ ${maxImages} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π`, 'info');
                    return;
                }

                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥–æ–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                for (let i = 0; i < e.target.files.length; i++) {
                    const file = e.target.files[i];
                    const imageId = 'image-' + Date.now() + '-' + i;
                    
                    try {
                        const galleryItem = await createGalleryItem(file, imageId);
                        imageGallery.appendChild(galleryItem);
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ –≤ –º–∞—Å—Å–∏–≤
                        uploadedImages.push({
                            id: imageId,
                            file: file
                        });
                    } catch (error) {
                        console.error('Error creating gallery item:', error);
                    }
                }
                
                updateImagesCounter();
                updateMoveButtons();
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ input, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –≤—ã–±—Ä–∞—Ç—å —Ç–µ –∂–µ —Ñ–∞–π–ª—ã —Å–Ω–æ–≤–∞
                e.target.value = '';
            }
        });

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ä–º—ã
        document.getElementById('add-product-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
            const productName = document.getElementById('product_name').value.trim();
            const productDescription = document.getElementById('product_description').value.trim();
            const priceValue = priceInput.value.trim();
            const locationValue = locationInput.value.trim();
            
            if (!productName) {
                showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞', 'error');
                document.getElementById('product_name').focus();
                return;
            }

            if (locationValue && !allCities.includes(locationValue)) {
                showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ –∏–∑ —Å–ø–∏—Å–∫–∞', 'error');
                locationInput.focus();
                return;
            }
            
            if (!productDescription) {
                showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞', 'error');
                document.getElementById('product_description').focus();
                return;
            }
            
            if (priceValue === '') {
                showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ —Ü–µ–Ω—É —Ç–æ–≤–∞—Ä–∞', 'error');
                priceInput.focus();
                return;
            }
            
            const price = parseFloat(priceValue) || 0;
            if (price < 0.1) {
                showNotification('–¶–µ–Ω–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–Ω—å—à–µ 0.1 TON', 'error');
                priceInput.focus();
                return;
            }
            
            if (price > 100000000) {
                showNotification('–¶–µ–Ω–∞ –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–µ–≤—ã—à–∞—Ç—å 100 000 000 TON', 'error');
                priceInput.focus();
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            if (uploadedImages.length === 0) {
                showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞', 'error');
                return;
            }

            const formData = new FormData(this);
            const submitBtn = this.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = '–ü—É–±–ª–∏–∫–∞—Ü–∏—è...';
            
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã –∏–∑ FormData
            formData.delete('product_images');
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
            uploadedImages.forEach(img => {
                formData.append('product_images', img.file);
            });

            try {
                const response = await fetch('/add_product', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (response.ok) {
                    showNotification('–û–±—ä—è–≤–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é!', 'success');
                    setTimeout(() => {
                        window.location.href = result.redirect || '/product_review?tab=moderation';
                    }, 1500);
                } else {
                    throw new Error(result.detail || result.message || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                }
                
            } catch (error) {
                const errorMessage = error.message.replace(/<[^>]*>?/gm, '');
                showNotification('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞: ' + errorMessage, 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = '–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å';
            }
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—á–µ—Ç—á–∏–∫–∞
        updateImagesCounter();
    });
</script>
{% endblock %}